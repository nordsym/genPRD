<!DOCTYPE html>
<html lang="sv" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GenPRD - AI-redo specs p√• sekunder</title>
    <meta name="description" content="Bygg b√§ttre appar snabbare med GenPRD. Fr√•n id√© till PRD p√• sekunder.">
    <link rel="icon" type="image/svg+xml" href="https://firebasestorage.googleapis.com/v0/b/nordsym-funnel.firebasestorage.app/o/genPRDfox.svg?alt=media&token=d22b3524-f29c-4313-bebb-2863f8c30b91">
    
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Stripe.js -->
    <script src="https://js.stripe.com/v3/"></script>

    <!-- Marked.js (F√∂r Markdown rendering) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Fonts: Outfit (Playful & Modern) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Icons: Phosphor -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                    },
                    colors: {
                        // Kawaii Palette Light
                        kBlue: '#6B9FFF',
                        kPurple: '#B19CD9',
                        kPink: '#FFB5BA',
                        kMint: '#A8E6CF',
                        kBg: '#FAFAFF', // Light purple tint
                        kSurface: '#FFFFFF',
                        kTextDark: '#2D3142',
                        kTextMedium: '#6B7280',
                        kBorder: '#E8E4F3',
                        
                        // Dreamy Night Palette (Dark Mode)
                        nightBg: '#1A1B2E',
                        nightSurface: '#242642',
                        nightBorder: '#3E4166',
                        nightText: '#EAEAF4'
                    },
                    borderRadius: {
                        'xl': '1rem',
                        '2xl': '1.5rem',
                        '3xl': '2rem',
                        'blob': '40% 60% 70% 30% / 40% 50% 60% 50%',
                    },
                    boxShadow: {
                        'soft': '0 10px 25px -5px rgba(107, 159, 255, 0.15), 0 8px 10px -6px rgba(107, 159, 255, 0.1)',
                        'glow': '0 0 20px rgba(177, 156, 217, 0.4)',
                        'button': '0 4px 14px 0 rgba(107, 159, 255, 0.39)',
                        'card': '0 8px 30px rgba(0,0,0,0.04)',
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'float-delayed': 'float 6s ease-in-out 3s infinite',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'sparkle': 'sparkle 2s ease-in-out infinite',
                        'blob': 'blob 7s infinite',
                        'cursor': 'cursor .75s step-end infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-20px)' },
                        },
                        sparkle: {
                            '0%, 100%': { opacity: '1', transform: 'scale(1)' },
                            '50%': { opacity: '0.5', transform: 'scale(0.8)' },
                        },
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        },
                        cursor: {
                            '0%, 100%': { borderRightColor: 'transparent' },
                            '50%': { borderRightColor: 'currentColor' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            /* Kawaii Softness */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        /* Apple-style Segmented Control */
        .segmented-control {
            background-color: rgba(229, 231, 235, 0.6); /* gray-200 with opacity */
            padding: 4px;
            border-radius: 12px;
            display: inline-flex;
            position: relative;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
        }
        .dark .segmented-control {
            background-color: rgba(36, 38, 66, 0.8); /* nightSurface */
        }
        
        .segment-indicator {
            position: absolute;
            top: 4px;
            bottom: 4px;
            border-radius: 8px;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1), 0 4px 8px rgba(0,0,0,0.05);
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1); /* Slower, smoother transition */
            z-index: 1;
        }
        .dark .segment-indicator {
            background-color: #3E4166;
        }

        /* Color states for indicator */
        .segment-indicator.state-bad {
            background-color: #FEE2E2; /* Red-100 */
        }
        .dark .segment-indicator.state-bad {
            background-color: #7F1D1D; /* Red-900 */
        }
        
        .segment-indicator.state-good {
            background-color: #D1FAE5; /* Emerald-100 */
        }
        .dark .segment-indicator.state-good {
            background-color: #064E3B; /* Emerald-900 */
        }

        .segment-btn {
            position: relative;
            z-index: 2;
            padding: 6px 20px;
            font-size: 0.9rem;
            font-weight: 600;
            color: #6B7280;
            transition: color 0.3s ease;
            cursor: pointer;
            border-radius: 8px;
        }
        .segment-btn.active-bad {
            color: #EF4444; /* Red-500 */
        }
        .segment-btn.active-good {
            color: #10B981; /* Emerald-500 */
        }
        .dark .segment-btn.active-bad {
            color: #FCA5A5; /* Red-300 */
        }
        .dark .segment-btn.active-good {
            color: #6EE7B7; /* Emerald-300 */
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #E8E4F3;
            border-radius: 20px;
            border: 3px solid transparent;
            background-clip: content-box;
        }
        .dark ::-webkit-scrollbar-thumb {
            background-color: #3E4166;
        }
        ::-webkit-scrollbar-thumb:hover {
            background-color: #B19CD9;
        }

        /* Gradient Text */
        .gradient-text {
            background: linear-gradient(135deg, #6B9FFF 0%, #B19CD9 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Floating Background Orbs */
        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.4;
            z-index: -1;
        }

        /* Card Hover Lift */
        .hover-lift {
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), box-shadow 0.3s ease;
        }
        .hover-lift:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px -5px rgba(107, 159, 255, 0.2);
        }

        /* Accordion Animation */
        .accordion-content {
            transition: grid-template-rows 0.4s ease-out;
            display: grid;
            grid-template-rows: 0fr;
        }
        .accordion-content > div {
            overflow: hidden;
        }
        .accordion-content.active {
            grid-template-rows: 1fr;
        }
    </style>
</head>
<body class="bg-kBg text-kTextDark dark:bg-nightBg dark:text-nightText overflow-x-hidden selection:bg-kPink selection:text-white">

    <!-- Background Orbs (Decorative - Shared) -->
    <div class="fixed top-0 left-0 w-full h-full overflow-hidden pointer-events-none z-0">
        <div class="orb w-96 h-96 bg-kBlue/30 top-[-10%] left-[-10%] animate-blob"></div>
        <div class="orb w-96 h-96 bg-kPurple/30 bottom-[10%] right-[-5%] animate-blob animation-delay-2000"></div>
        <div class="orb w-72 h-72 bg-kPink/20 top-[40%] left-[20%] animate-blob animation-delay-4000"></div>
    </div>

    <!-- ======================== PAYMENT MODAL (New) ======================== -->
    <div id="payment-modal" class="fixed inset-0 z-[70] hidden flex items-center justify-center bg-black/50 backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="bg-white dark:bg-nightSurface p-8 rounded-3xl shadow-card max-w-lg w-full mx-4 relative transform scale-95 transition-transform duration-300 border border-kBorder dark:border-nightBorder">
            <button onclick="togglePaymentModal(false)" class="absolute top-4 right-4 text-kTextMedium hover:text-kTextDark dark:text-gray-400 dark:hover:text-white transition-colors"><i class="ph-bold ph-x text-xl"></i></button>
            
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-kBlue/10 text-kBlue mb-4">
                    <i class="ph-fill ph-rocket-launch text-3xl"></i>
                </div>
                <h3 class="text-2xl font-bold dark:text-white mb-2">Uppgradera till Pro üöÄ</h3>
                <p class="text-kTextMedium dark:text-gray-400">F√• 200 genereringar i m√•naden och bygg snabbare.</p>
            </div>

            <div class="space-y-4">
                <!-- Annual Plan -->
                <button onclick="handleUpgrade('price_1Sn00IRtJYK3aJTq9gtj9vAs')" class="w-full group relative flex items-center justify-between p-4 rounded-2xl border-2 border-kBlue bg-kBlue/5 hover:bg-kBlue/10 transition-all text-left">
                    <div class="absolute -top-3 right-4 bg-kMint text-nightBg text-[10px] font-bold px-2 py-0.5 rounded-full">Spara 25%</div>
                    <div>
                        <span class="block font-bold text-lg text-kTextDark dark:text-white">√Örlig Plan</span>
                        <span class="text-sm text-kTextMedium">1114 kr / √•r</span>
                    </div>
                    <div class="w-8 h-8 rounded-full bg-kBlue text-white flex items-center justify-center group-hover:scale-110 transition-transform">
                        <i class="ph-bold ph-arrow-right"></i>
                    </div>
                </button>

                <!-- Monthly Plan -->
                <button onclick="handleUpgrade('price_1Sn00IRtJYK3aJTqt1Fjbx4V')" class="w-full flex items-center justify-between p-4 rounded-2xl border border-kBorder dark:border-nightBorder hover:border-kBlue hover:bg-kBg dark:hover:bg-nightBg transition-all text-left">
                    <div>
                        <span class="block font-bold text-lg text-kTextDark dark:text-white">M√•nadsvis</span>
                        <span class="text-sm text-kTextMedium">124 kr / m√•nad</span>
                    </div>
                    <div class="w-8 h-8 rounded-full bg-kBorder/50 text-kTextMedium flex items-center justify-center group-hover:scale-110 transition-transform">
                        <i class="ph-bold ph-arrow-right"></i>
                    </div>
                </button>
            </div>
            
            <p class="text-center text-xs text-kTextMedium mt-6 flex items-center justify-center gap-1">
                <i class="ph-fill ph-lock-key"></i> S√§kra betalningar via Stripe
            </p>
        </div>
    </div>

    <!-- ======================== INFO MODALS (Privacy & Terms) ======================== -->
    
    <!-- Privacy Modal -->
    <div id="privacy-modal" class="fixed inset-0 z-[80] hidden flex items-center justify-center bg-black/50 backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="bg-white dark:bg-nightSurface p-8 rounded-3xl shadow-card max-w-2xl w-full mx-4 relative transform scale-95 transition-transform duration-300 border border-kBorder dark:border-nightBorder flex flex-col max-h-[85vh]">
            <button onclick="toggleInfoModal('privacy', false)" class="absolute top-4 right-4 text-kTextMedium hover:text-kTextDark dark:text-gray-400 dark:hover:text-white transition-colors"><i class="ph-bold ph-x text-xl"></i></button>
            
            <div class="mb-6 flex-shrink-0">
                <h3 class="text-2xl font-bold dark:text-white flex items-center gap-2"><i class="ph-fill ph-shield-check text-kMint"></i> Integritetspolicy</h3>
                <p class="text-sm text-kTextMedium dark:text-gray-400">Senast uppdaterad: 7 Januari 2026</p>
            </div>

            <div class="overflow-y-auto custom-scrollbar pr-2 space-y-4 text-sm text-kTextDark dark:text-gray-300 leading-relaxed">
                <p class="font-medium">Vi p√• NordSym AB ("vi", "oss") v√§rnar om din integritet. Denna policy beskriver hur vi hanterar dina personuppgifter n√§r du anv√§nder GenPRD.</p>

                <h4 class="font-bold text-base text-kTextDark dark:text-white mt-4">1. Data vi samlar in</h4>
                <ul class="list-disc pl-5 space-y-1">
                    <li><strong>Konto-information:</strong> Din e-postadress och inloggningsuppgifter (hanteras s√§kert via Supabase).</li>
                    <li><strong>Anv√§ndargenererat inneh√•ll:</strong> De prompts du skriver och de PRDs som genereras.</li>
                    <li><strong>Anv√§ndningsdata:</strong> Information om hur du anv√§nder tj√§nsten, t.ex. antal genereringar (f√∂r kvothantering).</li>
                </ul>

                <h4 class="font-bold text-base text-kTextDark dark:text-white mt-4">2. Hur vi anv√§nder din data</h4>
                <p>Vi anv√§nder din data uteslutande f√∂r att:</p>
                <ul class="list-disc pl-5 space-y-1">
                    <li>Leverera tj√§nsten (skapa och spara dina specifikationer).</li>
                    <li>Hantera ditt konto och dina betalningar.</li>
                    <li>F√∂rb√§ttra tj√§nstens prestanda och s√§kerhet.</li>
                </ul>
                <p class="italic text-xs mt-2">Vi s√§ljer aldrig din data till tredje part f√∂r marknadsf√∂ring.</p>

                <h4 class="font-bold text-base text-kTextDark dark:text-white mt-4">3. Tredjepartstj√§nster</h4>
                <p>Vi anv√§nder p√•litliga underleverant√∂rer f√∂r att driva tj√§nsten:</p>
                <ul class="list-disc pl-5 space-y-1">
                    <li><strong>Supabase:</strong> Databas och autentisering.</li>
                    <li><strong>Stripe:</strong> Betalningshantering (vi lagrar aldrig dina kortuppgifter).</li>
                    <li><strong>Google/OpenAI/Anthropic:</strong> AI-modeller f√∂r textgenerering (data skickas via API men anv√§nds ej f√∂r att tr√§na deras modeller).</li>
                </ul>

                <h4 class="font-bold text-base text-kTextDark dark:text-white mt-4">4. Dina r√§ttigheter (GDPR)</h4>
                <p>Du har r√§tt att beg√§ra utdrag av din data, r√§ttelse av felaktig information, eller radering av ditt konto ("r√§tten att bli bortgl√∂md"). Kontakta oss p√• <a href="mailto:GenPRD@nordsym.com" class="text-kBlue hover:underline">GenPRD@nordsym.com</a> f√∂r √§renden.</p>
            </div>
            
            <div class="mt-6 pt-4 border-t border-kBorder dark:border-nightBorder flex justify-end flex-shrink-0">
                <button onclick="toggleInfoModal('privacy', false)" class="px-6 py-2 bg-kBg dark:bg-nightBg hover:bg-kBorder rounded-xl font-bold text-kTextDark dark:text-white transition-colors">St√§ng</button>
            </div>
        </div>
    </div>

    <!-- Terms Modal -->
    <div id="terms-modal" class="fixed inset-0 z-[80] hidden flex items-center justify-center bg-black/50 backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="bg-white dark:bg-nightSurface p-8 rounded-3xl shadow-card max-w-2xl w-full mx-4 relative transform scale-95 transition-transform duration-300 border border-kBorder dark:border-nightBorder flex flex-col max-h-[85vh]">
            <button onclick="toggleInfoModal('terms', false)" class="absolute top-4 right-4 text-kTextMedium hover:text-kTextDark dark:text-gray-400 dark:hover:text-white transition-colors"><i class="ph-bold ph-x text-xl"></i></button>
            
            <div class="mb-6 flex-shrink-0">
                <h3 class="text-2xl font-bold dark:text-white flex items-center gap-2"><i class="ph-fill ph-scroll text-kPurple"></i> Anv√§ndarvillkor</h3>
                <p class="text-sm text-kTextMedium dark:text-gray-400">G√§ller fr√•n: 7 Januari 2026</p>
            </div>

            <div class="overflow-y-auto custom-scrollbar pr-2 space-y-4 text-sm text-kTextDark dark:text-gray-300 leading-relaxed">
                <p class="font-medium">V√§lkommen till GenPRD. Genom att anv√§nda v√•r tj√§nst godk√§nner du f√∂ljande villkor.</p>

                <h4 class="font-bold text-base text-kTextDark dark:text-white mt-4">1. Tj√§nstens syfte</h4>
                <p>GenPRD √§r ett AI-baserat verktyg som hj√§lper anv√§ndare att skapa tekniska specifikationer (Product Requirements Documents). Tj√§nsten tillhandah√•lls "i befintligt skick".</p>

                <h4 class="font-bold text-base text-kTextDark dark:text-white mt-4">2. AI-ansvarsfriskrivning</h4>
                <div class="bg-kBlue/5 border border-kBlue/20 p-3 rounded-lg text-kTextDark dark:text-white">
                    <strong>Viktigt:</strong> Du f√∂rst√•r och accepterar att inneh√•ll som genereras av AI (Artificiell Intelligens) kan inneh√•lla felaktigheter, hallucinationer eller logiska luckor. Du √§r ensamt ansvarig f√∂r att granska, verifiera och godk√§nna alla specifikationer innan du anv√§nder dem f√∂r utveckling eller aff√§rsbeslut. NordSym AB tar inget ansvar f√∂r kodfel eller projektf√∂rseningar som uppst√•r baserat p√• genererat material.
                </div>

                <h4 class="font-bold text-base text-kTextDark dark:text-white mt-4">3. Immateriella r√§ttigheter</h4>
                <p><strong>Dina specifikationer:</strong> Du √§ger fulla r√§ttigheter till de texter och dokument du genererar med tj√§nsten.</p>
                <p><strong>V√•r tj√§nst:</strong> GenPRD:s kod, design och varum√§rke tillh√∂r NordSym AB.</p>

                <h4 class="font-bold text-base text-kTextDark dark:text-white mt-4">4. Betalning och Prenumeration</h4>
                <p>Vissa funktioner kr√§ver en betald prenumeration ("Pro"). Betalningar hanteras s√§kert via Stripe. Prenumerationer f√∂rnyas automatiskt om de inte s√§gs upp innan f√∂rnyelsedatumet. Vi erbjuder ingen √•terbetalning f√∂r redan p√•b√∂rjade m√•nader.</p>

                <h4 class="font-bold text-base text-kTextDark dark:text-white mt-4">5. Otill√•ten anv√§ndning</h4>
                <p>Du f√•r inte anv√§nda tj√§nsten f√∂r att generera olagligt, st√∂tande eller skadligt inneh√•ll, eller f√∂rs√∂ka kringg√• tj√§nstens s√§kerhetsmekanismer.</p>
            </div>
            
            <div class="mt-6 pt-4 border-t border-kBorder dark:border-nightBorder flex justify-end flex-shrink-0">
                <button onclick="toggleInfoModal('terms', false)" class="px-6 py-2 bg-gradient-to-r from-kBlue to-kPurple hover:shadow-glow text-white rounded-xl font-bold transition-all shadow-button">Jag f√∂rst√•r</button>
            </div>
        </div>
    </div>

    <!-- ======================== AUTH MODAL ======================== -->
    <div id="auth-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-black/50 backdrop-blur-sm opacity-0 transition-opacity duration-300">
        <div class="bg-white dark:bg-nightSurface p-8 rounded-3xl shadow-card max-w-md w-full mx-4 relative transform scale-95 transition-transform duration-300 border border-kBorder dark:border-nightBorder" id="auth-modal-content">
            <button onclick="toggleAuthModal(false)" class="absolute top-4 right-4 text-kTextMedium hover:text-kTextDark dark:text-gray-400 dark:hover:text-white transition-colors"><i class="ph-bold ph-x text-xl"></i></button>
            
            <!-- Login View -->
            <div id="login-view" class="space-y-6">
                <div class="text-center">
                    <div class="w-16 h-16 rounded-full bg-gradient-to-br from-kBlue to-kPurple p-[2px] mx-auto mb-4 shadow-soft">
                        <img src="https://firebasestorage.googleapis.com/v0/b/nordsym-funnel.firebasestorage.app/o/genPRDfox.svg?alt=media&token=d22b3524-f29c-4313-bebb-2863f8c30b91" class="w-full h-full rounded-full bg-white dark:bg-nightBg p-1 object-contain">
                    </div>
                    <h3 class="text-2xl font-bold dark:text-white">V√§lkommen tillbaka! üëã</h3>
                    <p class="text-kTextMedium dark:text-gray-400 text-sm">Logga in f√∂r att se dina sparade PRDs</p>
                </div>

                <!-- NEW: Error Container -->
                <div id="login-error-container" class="hidden bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl p-4 flex gap-3 items-start animate-pulse">
                    <div class="text-red-500 mt-0.5"><i class="ph-bold ph-warning-circle text-lg"></i></div>
                    <div class="text-sm text-red-600 dark:text-red-300 leading-relaxed" id="login-error-text"></div>
                </div>

                <form onsubmit="handleLogin(event)" class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold uppercase text-kTextMedium dark:text-gray-500 mb-1 ml-1">Email</label>
                        <input type="email" id="login-email" required class="w-full px-4 py-3 rounded-xl bg-kBg dark:bg-nightBg border border-kBorder dark:border-nightBorder focus:ring-2 focus:ring-kBlue focus:outline-none dark:text-white transition-all" placeholder="namn@exempel.se">
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase text-kTextMedium dark:text-gray-500 mb-1 ml-1">L√∂senord</label>
                        <input type="password" id="login-password" required class="w-full px-4 py-3 rounded-xl bg-kBg dark:bg-nightBg border border-kBorder dark:border-nightBorder focus:ring-2 focus:ring-kBlue focus:outline-none dark:text-white transition-all" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        <!-- UPDATED: Added Resend Confirmation link AND Forgot Password handler -->
                        <div class="flex justify-between items-center mt-1">
                            <button type="button" onclick="window.resendConfirmation()" class="text-xs text-kTextMedium hover:text-kBlue transition-colors">Ej f√•tt mail? Skicka igen</button>
                            <a href="#" onclick="handlePasswordReset(); return false;" class="text-xs text-kBlue hover:text-kPurple font-medium">Gl√∂mt l√∂senord?</a>
                        </div>
                    </div>
                    
                    <button type="submit" id="login-btn" class="w-full py-3 bg-gradient-to-r from-kBlue to-kPurple text-white font-bold rounded-xl shadow-button hover:shadow-glow hover:-translate-y-0.5 transition-all">
                        Logga in
                    </button>
                </form>

                <p class="text-center text-sm text-kTextMedium dark:text-gray-400">
                    Inget konto? <button onclick="switchAuthMode('signup')" class="text-kBlue font-bold hover:underline">Skapa konto</button>
                </p>
            </div>

            <!-- Signup View -->
            <div id="signup-view" class="hidden space-y-6">
                <div class="text-center">
                    <h3 class="text-2xl font-bold dark:text-white">Skapa konto ‚ú®</h3>
                    <p class="text-kTextMedium dark:text-gray-400 text-sm">Kom ig√•ng med GenPRD gratis</p>
                </div>

                <form onsubmit="handleSignup(event)" class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold uppercase text-kTextMedium dark:text-gray-500 mb-1 ml-1">Email</label>
                        <input type="email" id="signup-email" required class="w-full px-4 py-3 rounded-xl bg-kBg dark:bg-nightBg border border-kBorder dark:border-nightBorder focus:ring-2 focus:ring-kPink focus:outline-none dark:text-white transition-all" placeholder="namn@exempel.se">
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase text-kTextMedium dark:text-gray-500 mb-1 ml-1">L√∂senord</label>
                        <input type="password" id="signup-password" required class="w-full px-4 py-3 rounded-xl bg-kBg dark:bg-nightBg border border-kBorder dark:border-nightBorder focus:ring-2 focus:ring-kPink focus:outline-none dark:text-white transition-all" placeholder="V√§lj ett s√§kert l√∂senord">
                    </div>
                    <div class="flex items-start gap-2">
                        <input type="checkbox" required id="terms" class="mt-1 rounded border-gray-300 text-kPink focus:ring-kPink">
                        <label for="terms" class="text-xs text-kTextMedium dark:text-gray-400">Jag godk√§nner GenPRD's <button type="button" onclick="toggleInfoModal('terms', true)" class="underline hover:text-kBlue">villkor</button> och <button type="button" onclick="toggleInfoModal('privacy', true)" class="underline hover:text-kBlue">integritetspolicy</button>.</label>
                    </div>

                    <button type="submit" id="signup-btn" class="w-full py-3 bg-gradient-to-r from-kPink to-kPurple text-white font-bold rounded-xl shadow-button hover:shadow-glow hover:-translate-y-0.5 transition-all">
                        Skapa konto
                    </button>
                </form>

                <p class="text-center text-sm text-kTextMedium dark:text-gray-400">
                    Har du redan ett konto? <button onclick="switchAuthMode('login')" class="text-kBlue font-bold hover:underline">Logga in</button>
                </p>
            </div>
        </div>
    </div>

    <!-- ======================== LANDING VIEW ======================== -->
    <div id="landing-view" class="transition-opacity duration-500 ease-in-out">
        <!-- 1. Navigation -->
        <nav class="fixed w-full top-0 z-50 backdrop-blur-md bg-white/70 dark:bg-nightBg/80 border-b border-kBorder dark:border-nightBorder transition-colors duration-300">
            <div class="max-w-6xl mx-auto px-6 h-20 flex justify-between items-center">
                
                <!-- Logo -->
            <a href="#" class="flex items-center gap-3 group">
                <div class="w-14 h-14 rounded-full bg-gradient-to-br from-kBlue to-kPurple p-[2px] shadow-soft group-hover:scale-110 transition-transform duration-300">
                    <img src="https://firebasestorage.googleapis.com/v0/b/nordsym-funnel.firebasestorage.app/o/genPRDfox.svg?alt=media&token=d22b3524-f29c-4313-bebb-2863f8c30b91" alt="GenPRD Avatar" class="w-full h-full rounded-full bg-white dark:bg-nightSurface p-1 object-contain">
                </div>
                <span class="font-bold text-xl tracking-tight dark:text-white transition-colors">Gen<span class="text-kBlue">PRD</span></span>
            </a>

            <!-- Desktop Links -->
                <div class="hidden md:flex items-center gap-8 font-medium text-kTextMedium dark:text-gray-300">
                    <a href="#" class="hover:text-kBlue transition-colors hover:-translate-y-0.5 inline-block">Hem</a>
                    <a href="#features" class="hover:text-kBlue transition-colors hover:-translate-y-0.5 inline-block">Features</a>
                    <a href="#pricing" class="hover:text-kBlue transition-colors hover:-translate-y-0.5 inline-block">Priser</a>
                    <a href="#faq" class="hover:text-kBlue transition-colors hover:-translate-y-0.5 inline-block">FAQ</a>
                </div>

                <!-- Actions -->
                <div class="flex items-center gap-4">
                    <button id="theme-toggle" class="w-10 h-10 rounded-full bg-kBg dark:bg-nightSurface text-kTextMedium dark:text-kPink hover:bg-kPink/10 hover:text-kPink transition-all flex items-center justify-center shadow-sm">
                        <i id="theme-icon" class="ph-fill ph-moon text-xl"></i>
                    </button>
                    
                    <!-- DYNAMIC AUTH BUTTON -->
                    <div id="nav-auth-container">
                        <button onclick="toggleAuthModal(true)" class="hidden md:inline-block font-semibold text-kBlue hover:text-kPurple transition-colors">Sign in</button>
                    </div>
                    
                    <!-- Mobile Menu Btn -->
                    <button id="mobile-menu-btn" class="md:hidden w-10 h-10 rounded-full bg-white dark:bg-nightSurface shadow-sm flex items-center justify-center text-kTextDark dark:text-white">
                        <i class="ph ph-list text-2xl"></i>
                    </button>
                </div>
            </div>
        </nav>

        <!-- Mobile Menu Overlay -->
        <div id="mobile-menu" class="fixed inset-0 z-40 bg-white/95 dark:bg-nightBg/95 backdrop-blur-lg transform translate-x-full transition-transform duration-300 flex flex-col items-center justify-center gap-8 md:hidden">
            <button id="close-menu-btn" class="absolute top-6 right-6 w-10 h-10 rounded-full bg-kBg dark:bg-nightSurface flex items-center justify-center">
                <i class="ph ph-x text-2xl"></i>
            </button>
            
            <a href="#" class="text-2xl font-bold hover:text-kBlue">Hem</a>
            <a href="#features" class="text-2xl font-bold hover:text-kBlue">Features</a>
            <a href="#pricing" class="text-2xl font-bold hover:text-kBlue">Priser</a>
            <a href="#faq" class="text-2xl font-bold hover:text-kBlue">FAQ</a>
            <button onclick="toggleAuthModal(true); toggleMenu(false);" class="px-8 py-3 bg-gradient-to-r from-kBlue to-kPurple text-white rounded-full font-bold shadow-glow text-xl flex items-center gap-2">Logga in <i class="ph-fill ph-sign-in"></i></button>
        </div>

        <!-- 2. Hero Section (Updated ID Location) -->
        <section class="relative pt-32 pb-20 md:pt-48 md:pb-32 px-6 overflow-visible z-10" id="generate">
            <div class="max-w-4xl mx-auto text-center relative">
                <!-- Floating Icons -->
                <i class="ph-fill ph-sparkle text-kPink text-3xl absolute top-0 left-[10%] animate-sparkle"></i>
                <i class="ph-fill ph-star-four text-kBlue text-2xl absolute -top-10 right-[15%] animate-sparkle animation-delay-1000"></i>

                <h1 class="text-5xl md:text-7xl font-extrabold mb-6 tracking-tight leading-[1.1]">
                    AI-redo specs <br />
                    <span class="gradient-text flex items-center justify-center gap-3">p√• sekunder <i class="ph-fill ph-shooting-star text-kPurple"></i></span>
                </h1>
                <p class="text-xl text-kTextMedium dark:text-gray-400 mb-10 max-w-2xl mx-auto leading-relaxed">
                    Skriv din produktid√©. F√• en fokuserad spec som AI-agenter <span class="font-bold text-kTextDark dark:text-white bg-kPink/20 px-2 rounded-md">FAKTISKT</span> kan anv√§nda f√∂r att bygga din app.
                </p>

                <!-- Input Card -->
                <div class="relative max-w-3xl mx-auto group z-20">
                    <div class="absolute -inset-1 bg-gradient-to-r from-kBlue to-kPink rounded-[20px] blur opacity-25 group-hover:opacity-50 transition duration-1000 group-hover:duration-200"></div>
                    <div class="relative bg-white dark:bg-nightSurface rounded-[20px] shadow-card p-2 ring-1 ring-kBorder dark:ring-nightBorder">
                        <textarea 
                            id="prd-input"
                            class="w-full h-40 p-5 resize-none outline-none text-kTextDark dark:text-white placeholder-kTextMedium/50 bg-transparent text-lg rounded-2xl"
                            placeholder=""
                            maxlength="10000"
                        ></textarea>
                        
                        <div class="flex justify-between items-center px-4 pb-2">
                            <span id="char-count" class="text-xs font-bold text-kTextMedium/70 bg-kBg dark:bg-nightBg px-2 py-1 rounded-full">0 / 10,000</span>
                            <button onclick="window.enterAppWithPrompt()" class="bg-gradient-to-r from-kBlue to-kPurple text-white font-bold py-3 px-8 rounded-full shadow-button hover:shadow-glow hover:-translate-y-1 transition-all duration-300 flex items-center gap-2">
                                <span>Generera PRD</span>
                                <i class="ph-bold ph-magic-wand"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 3. Why GenPRD -->
        <section class="py-20 bg-white/50 dark:bg-nightSurface/30 backdrop-blur-sm border-y border-kBorder/50 dark:border-nightBorder">
             <div class="max-w-6xl mx-auto px-6">
                <div class="text-center mb-16">
                    <span class="inline-flex items-center gap-2 py-1 px-3 rounded-full bg-kBlue/10 text-kBlue text-sm font-bold uppercase tracking-wider mb-4">Varf√∂r GenPRD? <i class="ph-fill ph-star"></i></span>
                    <h2 class="text-3xl md:text-4xl font-bold mb-4">Ship-ready specs p√• sekunder</h2>
                    <p class="text-kTextMedium dark:text-gray-400 max-w-2xl mx-auto">Inget PM-fluff. Bara vad du (och din AI) beh√∂ver f√∂r att bygga direkt.</p>
                </div>

                <!-- Live Counters -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-20">
                <div class="bg-white dark:bg-nightSurface p-4 rounded-2xl shadow-soft flex flex-col items-center justify-center hover-lift border border-kBorder/50 dark:border-nightBorder">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="relative flex h-3 w-3">
                          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-kMint opacity-75"></span>
                          <span class="relative inline-flex rounded-full h-3 w-3 bg-kMint"></span>
                        </span>
                        <span class="text-xs font-bold text-kTextMedium uppercase tracking-wide">Status</span>
                    </div>
                    <span class="font-semibold text-sm">Uppdateras live</span>
                </div>

                <div class="bg-white dark:bg-nightSurface p-4 rounded-2xl shadow-soft flex flex-col items-center justify-center hover-lift border border-kBorder/50 dark:border-nightBorder">
                    <div class="flex -space-x-2 mb-2">
                        <div class="w-8 h-8 rounded-full border-2 border-white dark:border-nightSurface bg-kBlue text-white flex items-center justify-center text-xs font-bold">JD</div>
                        <div class="w-8 h-8 rounded-full border-2 border-white dark:border-nightSurface bg-kPink text-white flex items-center justify-center text-xs font-bold">AK</div>
                        <div class="w-8 h-8 rounded-full border-2 border-white dark:border-nightSurface bg-kPurple text-white flex items-center justify-center text-xs font-bold">LS</div>
                    </div>
                    <!-- √ÑNDRAT: Startar p√• 0 ist√§llet f√∂r 47 -->
                    <span class="font-bold text-xl" id="stats-builders">0 <span class="text-sm font-normal text-kTextMedium">byggare</span></span>
                </div>

                <div class="bg-white dark:bg-nightSurface p-4 rounded-2xl shadow-soft flex flex-col items-center justify-center hover-lift border border-kBorder/50 dark:border-nightBorder">
                    <i class="ph-duotone ph-file-text text-3xl mb-1 text-kBlue"></i>
                    <!-- √ÑNDRAT: Startar p√• 0 ist√§llet f√∂r 132 -->
                    <span class="font-bold text-xl" id="stats-generated">0 <span class="text-sm font-normal text-kTextMedium">genererade</span></span>
                </div>

                <div class="bg-white dark:bg-nightSurface p-4 rounded-2xl shadow-soft flex flex-col items-center justify-center hover-lift border border-kBorder/50 dark:border-nightBorder">
                    <i class="ph-duotone ph-hourglass-high text-3xl mb-1 text-kPurple"></i>
                    <span class="font-bold text-xl">‚àû <span class="text-sm font-normal text-kTextMedium">timmar sparade</span></span>
                </div>
            </div>

            <!-- Testimonial -->
            <div class="max-w-3xl mx-auto relative group">
                <div class="absolute inset-0 bg-gradient-to-r from-kBlue/20 to-kPurple/20 rounded-[30px] transform rotate-1 group-hover:rotate-2 transition-transform duration-300"></div>
                <div class="relative bg-white dark:bg-nightSurface p-8 md:p-10 rounded-[30px] shadow-card flex flex-col md:flex-row items-center gap-8 text-center md:text-left border border-kBorder dark:border-nightBorder">
                    <div class="w-20 h-20 flex-shrink-0 rounded-full bg-gradient-to-br from-kPink to-kPurple p-[3px]">
                        <div class="w-full h-full rounded-full bg-white dark:bg-nightSurface p-1">
                            <div class="w-full h-full rounded-full bg-kBlue text-white flex items-center justify-center text-2xl font-bold">AB</div>
                        </div>
                    </div>
                    <div>
                        <p class="text-lg md:text-xl font-medium leading-relaxed mb-4">
                            "GenPRD gjorde det enkelt att omvandla mina prompts till detaljerade specs. Det f√•ngade edge cases och hj√§lpte mig skapa appar med mindre debugging. Ren magi! <i class="ph-fill ph-sparkle text-kBlue inline align-middle"></i>"
                        </p>
                        <div>
                            <span class="block font-bold text-transparent bg-clip-text bg-gradient-to-r from-kBlue to-kPurple">@alex_builds</span>
                            <span class="text-sm text-kTextMedium">Produktbyggare</span>
                        </div>
                    </div>
                </div>
            </div>
             </div>
        </section>

        <!-- 4. GenPRD In Action -->
        <section class="py-20 overflow-hidden">
             <div class="max-w-6xl mx-auto px-6 text-center">
                <h2 class="text-3xl md:text-4xl font-bold mb-6 flex items-center justify-center gap-3">B√§ttre AI-byggda appar p√• under 3 minuter <i class="ph-fill ph-rocket-launch text-kPurple"></i></h2>
                <p class="text-kTextMedium dark:text-gray-400 mb-12">GenPRD fl√∂dar direkt in i ditt favorit AI-verktyg.</p>
                
                <div class="flex flex-wrap justify-center gap-6">
                    <div class="px-6 py-3 bg-white dark:bg-nightSurface rounded-full shadow-soft font-bold text-kTextDark dark:text-white flex items-center gap-2 border border-kBorder dark:border-nightBorder hover:scale-105 transition-transform cursor-default">
                        <i class="ph-fill ph-heart-straight text-[#FF4F00]"></i> Lovable
                    </div>
                    <div class="px-6 py-3 bg-white dark:bg-nightSurface rounded-full shadow-soft font-bold text-kTextDark dark:text-white flex items-center gap-2 border border-kBorder dark:border-nightBorder hover:scale-105 transition-transform cursor-default">
                        <i class="ph-fill ph-cursor-click text-black dark:text-white"></i> Cursor
                    </div>
                    <div class="px-6 py-3 bg-white dark:bg-nightSurface rounded-full shadow-soft font-bold text-kTextDark dark:text-white flex items-center gap-2 border border-kBorder dark:border-nightBorder hover:scale-105 transition-transform cursor-default">
                        <i class="ph-fill ph-code text-[#D97757]"></i> Claude Code
                    </div>
                    <div class="px-6 py-3 bg-white dark:bg-nightSurface rounded-full shadow-soft font-bold text-kTextDark dark:text-white flex items-center gap-2 border border-kBorder dark:border-nightBorder hover:scale-105 transition-transform cursor-default">
                        <i class="ph-fill ph-wind text-[#3B82F6]"></i> Windsurf
                    </div>
                    <div class="px-6 py-3 bg-white dark:bg-nightSurface rounded-full shadow-soft font-bold text-kTextDark dark:text-white flex items-center gap-2 border border-kBorder dark:border-nightBorder hover:scale-105 transition-transform cursor-default">
                        <i class="ph-fill ph-lightning text-[#F59E0B]"></i> Bolt
                    </div>
                </div>
            </div>
        </section>

        <!-- 5. Features -->
        <section id="features" class="py-20 bg-kBg dark:bg-nightBg relative">
             <div class="max-w-6xl mx-auto px-6">
                <div class="grid md:grid-cols-3 gap-8">
                    <!-- Feature 1 -->
                    <div class="bg-white dark:bg-nightSurface p-8 rounded-3xl shadow-soft hover-lift border border-kBorder/50 dark:border-nightBorder relative overflow-hidden group">
                        <div class="absolute top-0 right-0 w-24 h-24 bg-kBlue/10 rounded-bl-[100px] -mr-4 -mt-4 transition-all group-hover:bg-kBlue/20"></div>
                        <div class="w-14 h-14 bg-blue-50 dark:bg-blue-900/20 rounded-2xl flex items-center justify-center text-3xl mb-6 text-kBlue">
                            <i class="ph-fill ph-lightning"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-3">Inga tidslinjer, inget fluff</h3>
                        <p class="text-kTextMedium dark:text-gray-400 leading-relaxed">
                            Skippa "Fas 1"-tramset. AI bygger p√• timmar, s√• vi fokuserar p√• det som spelar roll: exakta specifikationer.
                        </p>
                    </div>
    
                    <!-- Feature 2 -->
                    <div class="bg-white dark:bg-nightSurface p-8 rounded-3xl shadow-soft hover-lift border border-kBorder/50 dark:border-nightBorder relative overflow-hidden group">
                        <div class="absolute top-0 right-0 w-24 h-24 bg-kPink/10 rounded-bl-[100px] -mr-4 -mt-4 transition-all group-hover:bg-kPink/20"></div>
                        <div class="w-14 h-14 bg-pink-50 dark:bg-pink-900/20 rounded-2xl flex items-center justify-center text-3xl mb-6 text-kPink">
                            <i class="ph-fill ph-target"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-3">Exakta tekniska detaljer</h3>
                        <p class="text-kTextMedium dark:text-gray-400 leading-relaxed">
                            F√§rger i hex-koder. Storlekar i pixlar. User flows steg-f√∂r-steg. Allt en AI-agent beh√∂ver f√∂r att b√∂rja koda.
                        </p>
                    </div>
    
                    <!-- Feature 3 -->
                    <div class="bg-white dark:bg-nightSurface p-8 rounded-3xl shadow-soft hover-lift border border-kBorder/50 dark:border-nightBorder relative overflow-hidden group">
                        <div class="absolute top-0 right-0 w-24 h-24 bg-kPurple/10 rounded-bl-[100px] -mr-4 -mt-4 transition-all group-hover:bg-kPurple/20"></div>
                        <div class="w-14 h-14 bg-purple-50 dark:bg-purple-900/20 rounded-2xl flex items-center justify-center text-3xl mb-6 text-kPurple">
                            <i class="ph-fill ph-magic-wand"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-3">Resultat p√• sekunder</h3>
                        <p class="text-kTextMedium dark:text-gray-400 leading-relaxed">
                            Det som brukade ta timmar av skrivande tar nu sekunder. Din id√© till implementeringsredo PRD.
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <!-- 6. Before/After Showcase -->
        <section class="py-20 md:py-28">
             <div class="max-w-6xl mx-auto px-6">
                <div class="text-center mb-12">
                    <h2 class="text-3xl md:text-4xl font-bold mb-4 flex items-center justify-center gap-3">Samma id√©. 10x b√§ttre output <i class="ph-fill ph-palette text-kPink"></i></h2>
                    <p class="text-kTextMedium dark:text-gray-400">Samma prompt. Olika instruktioner.</p>
                </div>
    
                <!-- The Prompt -->
                <div class="max-w-2xl mx-auto bg-white dark:bg-nightSurface border-2 border-kBlue/20 dark:border-kBlue/10 rounded-2xl p-6 text-center mb-12 shadow-lg relative">
                    <div class="absolute -top-3 left-1/2 -translate-x-1/2 bg-kBlue text-white text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wide">Prompten</div>
                    <p class="text-xl font-medium">"En kvitto-scanner som delar r√§kningar med v√§nner"</p>
                </div>
    
                <!-- Apple-Style Toggle -->
                <div class="flex justify-center mb-10">
                    <div class="segmented-control p-1 rounded-xl bg-gray-100 dark:bg-nightSurface border border-gray-200 dark:border-nightBorder">
                        <!-- √ÑNDRAT: state-good och left: 148px f√∂r att starta p√• h√∂ger sida -->
                        <div id="segment-indicator" class="segment-indicator state-good" style="width: 140px; left: 148px;"></div>
                        <!-- √ÑNDRAT: Text till "Utan GenPRD", tog bort active-bad klassen -->
                        <button class="segment-btn w-[140px]" onclick="switchShowcase('without')">Utan GenPRD</button>
                        <!-- √ÑNDRAT: Lade till active-good klassen -->
                        <button class="segment-btn active-good w-[140px]" onclick="switchShowcase('with')">Med GenPRD</button>
                    </div>
                </div>
    
                <!-- Comparison Grid (Left: Visuals, Right: Copy) -->
            <div class="grid md:grid-cols-2 gap-8 mb-16 items-stretch relative">
                
                <!-- Left Column: Visuals (Stacked & Absolute for smooth transition) -->
                <div class="relative bg-gray-100 dark:bg-nightSurface/50 rounded-3xl overflow-hidden border border-kBorder dark:border-nightBorder min-h-[500px] shadow-inner group/container">
                    
                    <!-- Visual: Without Spec (√ÑNDRAT: En bild, text fixad) -->
                    <div id="visual-without" class="absolute inset-0 flex flex-col items-center justify-center p-8 transition-all duration-500 ease-out opacity-0 scale-95 z-0 pointer-events-none">
                        <div class="aspect-[4/3] w-full bg-gray-200 dark:bg-gray-800 rounded-2xl flex flex-col items-center justify-center border-2 border-dashed border-gray-300 dark:border-gray-600 grayscale shadow-sm">
                            <div class="w-16 h-16 rounded-full bg-gray-300 dark:bg-gray-700 flex items-center justify-center mb-4">
                                <i class="ph-fill ph-image text-gray-400 text-3xl"></i>
                            </div>
                            <span class="text-gray-400 font-medium">Placeholder: "Kaos utan spec"</span>
                        </div>
                        <p class="mt-6 text-kTextMedium dark:text-gray-400 font-medium text-center">Agenten gissar sig fram...</p>
                    </div>

                    <!-- Visual: With FlowSpec (√ÑNDRAT: Karusell f√∂r 2 bilder, text fixad) -->
                    <div id="visual-with" class="absolute inset-0 flex flex-col items-center justify-center p-8 transition-all duration-500 ease-out opacity-100 scale-100 z-10 pointer-events-auto">
                        <div class="relative w-full aspect-[4/3] bg-white dark:bg-nightBg rounded-2xl overflow-hidden shadow-glow border border-kBlue/20">
                            
                            <!-- Slide 1 -->
                            <div id="carousel-slide-1" class="absolute inset-0 flex flex-col items-center justify-center bg-gradient-to-br from-kBlue/5 to-kPurple/5 transition-transform duration-500 ease-in-out">
                                <div class="w-16 h-16 rounded-full bg-kBlue/10 flex items-center justify-center mb-3 text-kBlue">
                                    <i class="ph-fill ph-image text-3xl"></i>
                                </div>
                                <span class="text-kBlue font-bold">Bild 1: PRD Preview</span>
                                <span class="text-xs text-kTextMedium mt-1">Placeholder</span>
                            </div>

                            <!-- Slide 2 -->
                            <div id="carousel-slide-2" class="absolute inset-0 flex flex-col items-center justify-center bg-gradient-to-br from-kPurple/5 to-kPink/5 translate-x-full transition-transform duration-500 ease-in-out">
                                <div class="w-16 h-16 rounded-full bg-kPurple/10 flex items-center justify-center mb-3 text-kPurple">
                                    <i class="ph-fill ph-image text-3xl"></i>
                                </div>
                                <span class="text-kPurple font-bold">Bild 2: F√§rdig App</span>
                                <span class="text-xs text-kTextMedium mt-1">Placeholder</span>
                            </div>

                            <!-- Navigation Arrows -->
                            <button onclick="window.switchCarousel('prev')" class="absolute left-3 top-1/2 -translate-y-1/2 w-8 h-8 rounded-full bg-white/80 dark:bg-black/50 hover:bg-white dark:hover:bg-black text-kTextDark dark:text-white shadow-sm flex items-center justify-center opacity-0 group-hover/container:opacity-100 transition-opacity z-20">
                                <i class="ph-bold ph-caret-left"></i>
                            </button>
                            <button onclick="window.switchCarousel('next')" class="absolute right-3 top-1/2 -translate-y-1/2 w-8 h-8 rounded-full bg-white/80 dark:bg-black/50 hover:bg-white dark:hover:bg-black text-kTextDark dark:text-white shadow-sm flex items-center justify-center opacity-0 group-hover/container:opacity-100 transition-opacity z-20">
                                <i class="ph-bold ph-caret-right"></i>
                            </button>

                            <!-- Dots -->
                            <div class="absolute bottom-3 left-1/2 -translate-x-1/2 flex gap-2 z-20">
                                <div id="dot-1" class="w-2 h-2 rounded-full bg-kBlue transition-colors shadow-sm cursor-pointer" onclick="window.switchCarousel(1)"></div>
                                <div id="dot-2" class="w-2 h-2 rounded-full bg-gray-300 dark:bg-gray-600 transition-colors shadow-sm cursor-pointer" onclick="window.switchCarousel(2)"></div>
                            </div>
                        </div>
                        <p class="mt-6 text-kBlue font-medium text-center">Agenten bygger en komplett app</p>
                    </div>

                </div>

                <!-- Right Column: Copy -->
                <div class="relative min-h-[500px]">
                    
                    <!-- Content: Without Spec (√ÑNDRAT: Dold som standard) -->
                    <div id="content-without" class="transition-all duration-500 ease-out opacity-0 -translate-x-8 absolute inset-0 z-0 pointer-events-none">
                        <div class="bg-gray-50 dark:bg-nightBg border border-gray-200 dark:border-gray-700 rounded-3xl p-8 h-full flex flex-col">
                            <div class="flex items-center gap-3 mb-6">
                                <div class="w-10 h-10 rounded-full bg-red-100 dark:bg-red-900/30 flex items-center justify-center text-red-500">
                                    <i class="ph-bold ph-x-circle text-2xl"></i>
                                </div>
                                <h3 class="text-2xl font-bold text-gray-500 dark:text-gray-400">Utan GenPRD</h3>
                            </div>
                            
                            <p class="text-lg font-bold text-gray-600 dark:text-gray-300 mb-2">Agenten improviserar</p>
                            <p class="text-gray-500 dark:text-gray-400 mb-6 leading-relaxed text-sm">
                                Utan tydliga ramar gissar agenten. Du f√•r en ytlig demo som saknar logik och struktur.
                            </p>

                            <div class="space-y-4 mt-2">
                                <div class="flex items-center gap-3 text-gray-500 dark:text-gray-400">
                                    <i class="ph-bold ph-x text-red-400 text-lg"></i>
                                    <span>En enda sida ‚Äì ingen auth eller routing</span>
                                </div>
                                <div class="flex items-center gap-3 text-gray-500 dark:text-gray-400">
                                    <i class="ph-bold ph-x text-red-400 text-lg"></i>
                                    <span>In-memory state ‚Äì inget sparas</span>
                                </div>
                                <div class="flex items-center gap-3 text-gray-500 dark:text-gray-400">
                                    <i class="ph-bold ph-x text-red-400 text-lg"></i>
                                    <span>Inget databasschema</span>
                                </div>
                                <div class="flex items-center gap-3 text-gray-500 dark:text-gray-400">
                                    <i class="ph-bold ph-x text-red-400 text-lg"></i>
                                    <span>Grundl√§ggande funktionellt UI</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Content: With GenPRD (√ÑNDRAT: Visad som standard) -->
                    <div id="content-with" class="transition-all duration-500 ease-out opacity-100 translate-x-0 absolute inset-0 z-10 pointer-events-auto">
                        <div class="bg-white dark:bg-nightSurface border-2 border-kBlue rounded-3xl p-8 shadow-glow h-full flex flex-col relative overflow-hidden">
                            <div class="absolute top-0 right-0 bg-kBlue text-white text-[10px] font-bold px-3 py-1 rounded-bl-xl z-10 tracking-wider">PRODUCTION READY</div>
                            
                            <div class="flex items-center gap-3 mb-6">
                                <div class="w-10 h-10 rounded-full bg-kMint/20 text-kMint flex items-center justify-center text-xl">
                                    <i class="ph-bold ph-check-circle"></i>
                                </div>
                                <h3 class="text-2xl font-bold text-kTextDark dark:text-white">Med GenPRD</h3>
                            </div>

                            <div class="space-y-3 mb-6 flex-grow">
                                <div class="flex items-center gap-3 bg-kBg dark:bg-nightBg p-3 rounded-xl border border-kBorder dark:border-nightBorder">
                                    <i class="ph-fill ph-lock-key text-kMint text-xl"></i>
                                    <span class="font-medium text-sm">6 sidor med auth + routing</span>
                                </div>
                                <div class="flex items-center gap-3 bg-kBg dark:bg-nightBg p-3 rounded-xl border border-kBorder dark:border-nightBorder">
                                    <i class="ph-fill ph-database text-kMint text-xl"></i>
                                    <span class="font-medium text-sm">7-tabellers Supabase-schema + RLS</span>
                                </div>
                                <div class="flex items-center gap-3 bg-kBg dark:bg-nightBg p-3 rounded-xl border border-kBorder dark:border-nightBorder">
                                    <i class="ph-fill ph-files text-kMint text-xl"></i>
                                    <span class="font-medium text-sm">Fillagring + OCR-statusfl√∂de</span>
                                </div>
                                <div class="flex items-center gap-3 bg-kBg dark:bg-nightBg p-3 rounded-xl border border-kBorder dark:border-nightBorder">
                                    <i class="ph-fill ph-rocket-launch text-kMint text-xl"></i>
                                    <span class="font-medium text-sm">Landningssida + onboarding</span>
                                </div>
                            </div>

                            <div class="mt-auto">
                                <button onclick="window.toggleSpec()" class="text-xs font-bold text-kBlue hover:text-white hover:bg-kBlue transition-colors flex items-center justify-center gap-2 w-full py-3 px-2 bg-kBlue/10 rounded-xl h-auto min-h-[44px] whitespace-normal text-center">
                                    Se GenPRD-specen som gjorde detta m√∂jligt <i class="ph-bold ph-arrow-down flex-shrink-0"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                </div>
            </div> <!-- Closes Comparison Grid -->
            </div> <!-- CRITICAL FIX: Closes max-w-6xl container from line 506 -->

            <!-- Spec Expander Content -->
            <div id="spec-content" class="hidden transition-all duration-700 ease-in-out overflow-hidden max-h-0 opacity-0 mb-20 px-6">
                <div class="max-w-5xl mx-auto">
                    
                    <!-- VISUAL CUE: Prompt -> Result (Redesigned) -->
                    <div class="flex flex-col items-center justify-center mb-8 space-y-4 pt-4">
                        <!-- Input Bubble -->
                        <div class="relative bg-white dark:bg-nightSurface rounded-2xl rounded-bl-none shadow-glow p-6 max-w-lg w-full border border-kBorder dark:border-nightBorder transform transition-transform hover:scale-[1.02]">
                            <div class="absolute -top-3 left-6 bg-gradient-to-r from-kBlue to-kPurple text-white text-[10px] font-bold px-3 py-1 rounded-full uppercase tracking-wider shadow-sm">
                                <i class="ph-bold ph-lightbulb"></i> Input: Din Id√©
                            </div>
                            <p class="text-xl font-medium text-kTextDark dark:text-white leading-relaxed">
                                "En kvitto-scanner som delar r√§kningar med v√§nner"
                            </p>
                        </div>
                        
                        <!-- Arrow -->
                        <div class="h-10 flex items-center justify-center">
                            <div class="w-px h-full bg-gradient-to-b from-kBorder to-transparent dark:from-nightBorder"></div>
                            <div class="absolute bg-white dark:bg-nightBg p-2 rounded-full border border-kBorder dark:border-nightBorder text-kPurple shadow-sm animate-bounce">
                                <i class="ph-bold ph-arrow-down text-xl"></i>
                            </div>
                        </div>
                    </div>

                    <!-- PRD Window (Themed) -->
                    <div class="bg-white dark:bg-[#1e1e1e] text-kTextDark dark:text-[#d4d4d4] rounded-2xl shadow-2xl border border-kBorder dark:border-gray-800 overflow-hidden font-mono text-sm text-left relative group transition-colors duration-500">
                        <!-- Close Button -->
                        <button onclick="window.toggleSpec()" class="absolute top-3 right-4 text-kTextMedium dark:text-gray-500 hover:text-kTextDark dark:hover:text-white transition-colors z-10 p-1">
                            <i class="ph-bold ph-x text-lg"></i>
                        </button>

                        <!-- Window Bar -->
                        <div class="bg-gray-50 dark:bg-[#2d2d2d] px-4 py-3 flex items-center justify-between border-b border-kBorder dark:border-black/20 transition-colors duration-500">
                            <div class="flex gap-2">
                                <div class="w-3 h-3 rounded-full bg-[#ff5f56] border border-black/10"></div>
                                <div class="w-3 h-3 rounded-full bg-[#ffbd2e] border border-black/10"></div>
                                <div class="w-3 h-3 rounded-full bg-[#27c93f] border border-black/10"></div>
                            </div>
                            <div class="text-xs text-kTextMedium dark:text-gray-500 font-medium font-sans flex items-center gap-2">
                                <i class="ph-fill ph-file-text text-kBlue"></i> ReceiptSplit_PRD.md
                            </div>
                            <div class="w-10"></div>
                        </div>
                        
                        <!-- Content -->
                        <div class="p-8 h-[600px] overflow-y-auto custom-scrollbar bg-white dark:bg-[#1e1e1e] transition-colors duration-500">
                            <pre class="whitespace-pre-wrap font-mono text-xs md:text-sm leading-relaxed text-gray-600 dark:text-gray-300">
ReceiptSplit ‚Äî Product Requirements Document

## 1) Summary
ReceiptSplit is a web app for authenticated users to scan or upload receipts, automatically extract line items, and split costs among friends with precise shares. It targets friend groups, roommates, or colleagues who need an audited, editable split from photographed receipts. Core value: reduce manual entry by converting receipt images into editable items and shareable payment splits.

## 2) Tech Stack
- Framework: Next.js 15 App Router (React)
- Database: Supabase PostgreSQL
- Auth: Supabase Auth (email + magic link)
- Styling: Tailwind CSS + shadcn/ui
- Key libs: Tesseract.js (OCR), Zod (validation), React Hook Form (forms), dayjs (dates)
- Deployment: Vercel

## 3) User Roles
- Authenticated User
  - Permissions: create receipts, upload images, edit extracted items, create groups, invite friends (by email), assign shares, finalize splits, generate share links (read-only).
- No anonymous access. All actions require login.

## 4) Data Model

Entities:

1) User
- id: uuid (primary)
- email: string (unique, required)
- display_name: string (nullable, default = user's email local part)
- avatar_url: string (nullable)
- created_at: timestamp (default now)

2) Group
- id: uuid (primary)
- name: string (required)
- owner_user_id: uuid (foreign -> User.id)
- created_at: timestamp (default now)
- is_private: boolean (default true)

Relationships: User 1‚Äî* Group via membership

3) GroupMember
- id: uuid (primary)
- group_id: uuid (foreign -> Group.id)
- user_id: uuid (foreign -> User.id)
- role: enum('member','admin') (default 'member')
- created_at: timestamp (default now)

Relationships: Group 1‚Äî* GroupMember; User 1‚Äî* GroupMember

4) Receipt
- id: uuid (primary)
- user_id: uuid (foreign -> User.id) ‚Äî creator/uploader
- group_id: uuid (foreign -> Group.id) nullable
- original_image_url: string (required)
- merchant: string (nullable)
- total_amount_cents: integer (nullable)
- currency: string (3-letter ISO, default 'USD')
- date: date (nullable)
- ocr_status: enum('pending','complete','failed') (default 'pending')
- created_at: timestamp (default now)

Relationships: Receipt 1‚Äî* Item; Receipt 1‚Äî* Share

5) Item
- id: uuid (primary)
- receipt_id: uuid (foreign -> Receipt.id)
- description: string (required)
- quantity: integer (default 1)
- unit_price_cents: integer (required)
- total_price_cents: integer (computed: quantity * unit_price_cents)
- tag: string (nullable)
- position_index: integer (order on receipt; default 0)

Relationships: Receipt 1‚Äî* Item

6) Share
- id: uuid (primary)
- receipt_id: uuid (foreign -> Receipt.id)
- item_id: uuid (foreign -> Item.id) nullable ‚Äî if null, row-level share for receipt-level fee/tax
- payer_user_id: uuid (foreign -> User.id) ‚Äî who paid at checkout
- participant_user_id: uuid (foreign -> User.id) ‚Äî who owes
- share_type: enum('percentage','fixed_cents','equal') (required)
- share_value: integer (if percentage -> 0-100; if fixed_cents -> cents; if equal -> integer count)
- amount_cents: integer (computed) ‚Äî final owed cents after calculation and rounding
- settled: boolean (default false)

Relationships: Receipt 1‚Äî* Share; Item 1‚Äî* Share (optional)

7) Adjustment
- id: uuid (primary)
- receipt_id: uuid (foreign -> Receipt.id)
- description: string (e.g., 'Tax', 'Tip')
- amount_cents: integer (can be positive or negative)
- split_method: enum('by_share','per_person_equal') (default 'by_share')

Notes:
- All monetary fields stored in integer cents. No floating points.
- Computed fields are computed on write and stored for audit; recomputed on edits.

## 5) Core Features

Feature A: Upload & OCR Receipt
- User Flow:
  1. User clicks "Upload receipt" button on dashboard.
  2. File chooser appears; user selects image or PDF (single page).
  3. UI shows image preview and "Run OCR" primary button.
  4. User clicks "Run OCR".
  5. App sends image to server; server persists Receipt with ocr_status='pending' and returns receipt id.
  6. Server processes OCR via Tesseract.js headless worker; extracts merchant, date, total, and line items.
  7. On success, server sets ocr_status='complete' and returns parsed items; frontend displays editable list.
  8. On OCR fail, server sets ocr_status='failed' and frontend shows error state with manual entry option.

- UI Copy & Colors:
  - Upload CTA: "Upload receipt" (button background #0A84FF, text #FFFFFF)
  - Run OCR CTA: "Run OCR" (button background #0A84FF, text #FFFFFF)
  - OCR progress: "Scanning receipt‚Ä¶" (text #1F2937)
  - OCR success headline: "Receipt scanned ‚Äî edit items" (#111827)
  - Manual entry CTA: "Manually add item" (button border #0A84FF, text #0A84FF)
- Error & Empty States:
  - OCR fail message: "We couldn't read this receipt. Tap 'Manually add item' to enter items yourself." (error text #B00020)
  - Upload invalid file type: "Unsupported file type. Upload JPG, PNG, or PDF." (error text #B00020)
- Acceptance Checks:
  - ‚úì Uploading a valid image creates a Receipt with ocr_status pending.
  - ‚úì Successful OCR updates receipt.ocr_status to 'complete' and returns at least merchant or total or items.
  - ‚úì Failed OCR sets ocr_status to 'failed' and shows manual entry CTA.

Feature B: Edit Items & Adjustments
- User Flow:
  1. After OCR complete or manual receipt creation, user sees a list: each row shows description, quantity, unit price, total.
  2. User clicks an item field to edit inline; edits validated on blur.
  3. User can click "Add item" to append a new row.
  4. User can add adjustments via "Add adjustment" with description and amount.
  5. User clicks "Save items" to persist edits.

- UI Copy & Colors:
  - Headline: "Edit items" (#111827)
  - Table headers: "Item", "Qty", "Unit price", "Total" (#6B7280)
  - Add item button: "+ Add item" (text #0A84FF, outline #0A84FF)
  - Save button: "Save items" (button background #0066CC, text #FFFFFF)
  - Adjustment label: "Add adjustment" (text #111827)
- Error & Empty States:
  - Empty items: "No items found. Add items to split this bill." with "+ Add item" CTA (#6B7280)
  - Validation: "Quantity must be at least 1." (error #B00020)
  - Validation: "Unit price must be greater than 0." (error #B00020)
- Acceptance Checks:
  - ‚úì Adding an item persists one Item record with correct computed total_price_cents.
  - ‚úì Invalid quantity or price shows validation error and blocks save.
  - ‚úì Adjustments persist as Adjustment rows linked to receipt.

Feature C: Create Split & Assign Shares
- User Flow:
  1. From receipt page, user clicks "Split with friends".
  2. Modal opens with two tabs: "By item" and "By person".
  3. User selects participants by typing friend email (autocomplete from Group members or users) and clicking "Add".
  4. For "By item": for each item row, user clicks participant checkboxes or selects percentages per participant. For equal split, click "Split equally".
  5. For "By person": user can add fixed amounts or percentages per person for entire receipt.
  6. User clicks "Preview split".
  7. Preview shows each participant's amount in dollars and cents and rounding adjustments.
  8. User clicks "Finalize split" which creates Share rows with computed amount_cents.
  9. App marks payer as the uploader by default; user can change payer via dropdown labeled "Who paid?" (options: participant list).
  10. After finalizing, shareable read-only link button appears: "Copy share link".

- UI Copy & Colors:
  - CTA: "Split with friends" (button background #0A84FF, text #FFFFFF)
  - Modal title: "Split receipt" (#111827)
  - Tab labels: "By item", "By person" (#6B7280)
  - Participant add placeholder: "Enter email to add" (input border #D1D5DB)
  - Buttons: "Preview split" (background #FFD60A, text #111827), "Finalize split" (background #0066CC, text #FFFFFF)
  - Copy link button: "Copy share link" (background #F3F4F6, text #111827)
- Error & Empty States:
  - No participants: "Add at least one person to split this receipt." (error #B00020)
  - Share rounding conflict: "Rounding caused a 1-cent mismatch. Verify participant amounts." (warning #FF8C00)
- Acceptance Checks:
  - ‚úì Adding participants and choosing split method computes total of all share.amount_cents equal to receipt total + adjustments.
  - ‚úì Preview displays per-participant cents with rounding detail.
  - ‚úì Finalize creates Share rows with correct payer and settled=false.

Feature D: Share & Accept
- User Flow:
  1. After finalize, user copies share link and sends to participants.
  2. Recipient opens link; if not logged in, must log in. After login, they see a read-only page with "Your amount" and an "Accept" button.
  3. Recipient clicks "Accept" to mark their share as acknowledged; this sets share.accepted = true (additional boolean stored).
  4. Payer can mark individual shares as "Settled" after confirming payment (button "Mark settled").

- UI Copy & Colors:
  - Read-only CTA: "Accept" (button background #10B981, text #FFFFFF)
  - Payer settle CTA: "Mark settled" (button background #0A84FF, text #FFFFFF)
  - Share page headline: "You owe $X.XX" (#111827)
- Error & Empty States:
  - If user opens link for a share that does not exist: "This split link is invalid or expired." (error #B00020)
  - If user not authorized to view group: "You must be a member to view this split. Request access from the payer." (error #B00020)
- Acceptance Checks:
  - ‚úì Share link resolves to correct receipt and participant amount for logged-in user.
  - ‚úì Clicking "Accept" sets share.accepted=true and updates UI to "Accepted".

Feature E: Receipt & Share History
- User Flow:
  1. Dashboard lists receipts created by user with merchant, date, total, and split status.
  2. Clicking a receipt opens details with items, adjustments, participants and settled status.
  3. User filters by "Unsettled" or "All".

- UI Copy & Colors:
  - Dashboard heading: "Your receipts" (#111827)
  - Filters: "All", "Unsettled" (button active background #0A84FF, inactive #F3F4F6)
  - Empty dashboard: "No receipts yet. Upload your first receipt." CTA: "Upload receipt" (#0A84FF)
- Error & Empty States:
  - Dashboard load fail: "Couldn't load your receipts. Tap 'Retry' to try again." with "Retry" button (#0A84FF)
- Acceptance Checks:
  - ‚úì Dashboard lists created receipts sorted by created_at descending.
  - ‚úì Filters change list accordingly without console errors.

## 6) UI/UX

Color palette (use all):
- Primary blue: #0A84FF ‚Äî primary buttons, links
- Accent blue: #0066CC ‚Äî prominent actions like "Save items" and "Finalize"
- Success green: #10B981 ‚Äî accept/positive confirmations
- Danger red: #B00020 ‚Äî errors, validation messages
- Warning amber: #FF8C00 ‚Äî rounding or non-fatal warnings
- Neutral dark text: #111827 ‚Äî primary headings
- Neutral mid text: #6B7280 ‚Äî secondary text
- Background: #F8FAFC ‚Äî page background
- Surface: #FFFFFF ‚Äî cards and modals
- Muted: #F3F4F6 ‚Äî inactive controls

Typography:
- Inter, 16px base, 20px H3, 24px H2, 32px H1. Line-height 1.4. Use 500 weight for headings, 400 for body.

Layout notes:
- Mobile-first single column; dashboard shows list cards full width.
- Desktop: receipts list left column 360px, detail pane right column flexible.
- Modals centered with max-width 720px, background overlay #00000080.

## 7) Out of Scope (V1)
- Automatic payment collection or wallets (no payment processing).
- Multi-currency split conversions (all receipts use single currency per receipt; no FX).
- Shared group permissions beyond member/admin (no role hierarchy changes).
- Recurring receipts/subscriptions.
- Mobile native apps; only web app supported.
- OCR human review queue and paid verification service.
- Automatic merchant categorization beyond merchant name extraction.
- Receipt merging/duplicate detection.
- Bank integrations or direct bill pay links.

## 8) Success Criteria (Testable Checklist)
- ‚úì A logged-in user can upload an image and create a Receipt record with ocr_status 'pending'.
- ‚úì OCR process sets ocr_status to 'complete' and returns editable Item records OR sets 'failed' and shows manual entry CTA.
- ‚úì User can add/edit/delete items and adjustments; totals update and persist with cents accuracy.
- ‚úì User can add participants, preview split with cents-level breakdown, and finalize creating Share rows whose summed amount_cents equals receipt total + adjustments.
- ‚úì Share link opens to authenticated recipient showing correct amount and enabling "Accept" which sets accepted=true.
- ‚úì Dashboard lists receipts and filters without console errors; empty dashboard shows "No receipts yet. Upload your first receipt." with CTA.
- ‚úì All validation errors show specified messages in #B00020 and block invalid saves.
- ‚úì UI uses specified colors for corresponding elements (primary buttons #0A84FF, success #10B981, danger #B00020, background #F8FAFC, text #111827).

TBD: OCR fallback behavior for multi-page PDFs ‚Äî should the app process only first page or all pages? Please confirm desired behavior.
                            </pre>
                        </div>
                    </div>

                    <!-- NEW CTA SECTION -->
                    <div class="text-center mt-10">
                         <h3 class="text-2xl font-bold mb-6 flex items-center justify-center gap-2">
                            Redo att bygga n√•got riktigt? <i class="ph-fill ph-rocket-launch text-kPurple"></i>
                        </h3>
                        <a href="#generate" onclick="window.toggleSpec()" class="inline-flex items-center gap-2 bg-gradient-to-r from-kBlue to-kPurple text-white text-lg font-bold py-4 px-8 rounded-full shadow-button hover:shadow-glow hover:-translate-y-1 transition-all duration-300">
                            Generera din egen PRD <i class="ph-fill ph-sparkle"></i>
                        </a>
                    </div>
                </div>
            </div>

        </section> <!-- Closes Showcase Section -->

        <!-- 7. Pricing Section -->
        <section id="pricing" class="pb-20 pt-10">
             <div class="max-w-6xl mx-auto px-6 text-center">
                <h2 class="text-3xl md:text-4xl font-bold mb-4 flex items-center justify-center gap-3">Enkel, Transparent Priss√§ttning <i class="ph-fill ph-coins text-kPink"></i></h2>
                <p class="text-kTextMedium dark:text-gray-400 mb-2">Kom ig√•ng GRATIS med 50 genereringar. Inget betalkort kr√§vs.</p>
                <p class="text-sm text-kTextMedium dark:text-gray-500 mb-12">Alla funktioner ing√•r fr√•n start.</p>
    
                <!-- Toggle with Floating Promo -->
                <div class="relative inline-block mb-12">
                    <!-- Floating Copy & Arrow -->
                    <div class="absolute left-full top-1/2 -translate-y-1/2 ml-4 flex items-center gap-2 z-20 pointer-events-none hidden md:flex">
                        <i class="ph-fill ph-arrow-left text-kPink text-2xl animate-pulse-slow"></i>
                        <span class="text-[11px] font-bold text-white bg-kPink px-3 py-1.5 rounded-xl shadow-sm transform rotate-3 whitespace-nowrap border border-white/20">
                            3 m√•nader gratis!
                        </span>
                    </div>

                    <div class="flex items-center justify-center gap-2 bg-white dark:bg-nightSurface p-1.5 rounded-full border border-kBorder dark:border-nightBorder shadow-sm relative z-10">
                        <button id="monthly-btn" class="px-6 py-2 rounded-full font-bold text-white bg-kBlue shadow-sm transition-all">M√•nadsvis</button>
                        <button id="yearly-btn" class="px-6 py-2 rounded-full font-bold text-kTextMedium hover:text-kBlue transition-all">
                            √Örsvis
                        </button>
                    </div>
                </div>
    
                <!-- Card -->
                <div class="max-w-md mx-auto relative group">
                    <div class="absolute -inset-2 bg-gradient-to-tr from-kBlue via-kPurple to-kPink rounded-[40px] blur opacity-40 group-hover:opacity-60 transition duration-500"></div>
                    <div class="relative bg-white dark:bg-nightSurface p-10 rounded-[35px] shadow-card">
                        <div class="inline-block bg-gradient-to-r from-kBlue to-kPurple text-white text-xs font-bold px-4 py-1.5 rounded-full mb-6">PRO PLAN</div>
                        
                        <div class="flex flex-col items-center mb-2">
                            <div class="flex items-baseline justify-center gap-1">
                                <span id="price-amount" class="text-6xl font-extrabold tracking-tight">99 kr</span>
                                <span id="price-period" class="text-kTextMedium font-medium">/m√•nad</span>
                            </div>
                            <span class="text-sm text-kTextMedium font-medium mt-1">exkl. moms</span>
                        </div>
                        <div id="price-savings" class="text-sm text-kMint font-bold h-6 mb-8 text-center"></div>
    
                        <ul class="space-y-4 text-left mb-10 pl-4">
                            <li class="flex items-center gap-3">
                                <div class="w-6 h-6 rounded-full bg-kMint/20 flex items-center justify-center text-kMint text-xs font-bold">
                                    <i class="ph-bold ph-check"></i>
                                </div>
                                <span class="font-medium">200 PRD-genereringar per m√•nad</span>
                            </li>
                            <li class="flex items-center gap-3">
                                <div class="w-6 h-6 rounded-full bg-kMint/20 flex items-center justify-center text-kMint text-xs font-bold">
                                    <i class="ph-bold ph-check"></i>
                                </div>
                                <span class="font-medium">Full tillg√•ng till alla features</span>
                            </li>
                            <li class="flex items-center gap-3">
                                <div class="w-6 h-6 rounded-full bg-kMint/20 flex items-center justify-center text-kMint text-xs font-bold">
                                    <i class="ph-bold ph-check"></i>
                                </div>
                                <span class="font-medium">PRDs sparade f√∂r evigt</span>
                            </li>
                            <li class="flex items-center gap-3">
                                <div class="w-6 h-6 rounded-full bg-kMint/20 flex items-center justify-center text-kMint text-xs font-bold">
                                    <i class="ph-bold ph-check"></i>
                                </div>
                                <span class="font-medium">Exportera till Markdown</span>
                            </li>
                            <li class="flex items-center gap-3">
                                <div class="w-6 h-6 rounded-full bg-kMint/20 flex items-center justify-center text-kMint text-xs font-bold">
                                    <i class="ph-bold ph-check"></i>
                                </div>
                                <span class="font-medium">Bifoga bilder till din prompt</span>
                            </li>
                        </ul>
    
                        <button onclick="if(currentUser) togglePaymentModal(true); else toggleAuthModal(true);" class="w-full py-4 bg-kTextDark dark:bg-white text-white dark:text-nightBg rounded-2xl font-bold text-lg hover:scale-[1.02] active:scale-95 transition-transform shadow-button flex items-center justify-center gap-2">
                            Starta 7-dagars gratis provperiod <i class="ph-fill ph-sparkle"></i>
                        </button>
                        <p class="text-xs text-kTextMedium mt-4">Efter trial: Uppgradera eller l√§s√•tkomst</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- 8. FAQ -->
        <section id="faq" class="py-20">
             <div class="max-w-3xl mx-auto px-6">
                <h2 class="text-3xl font-bold text-center mb-12 flex items-center justify-center gap-3">Vanliga Fr√•gor <i class="ph-fill ph-chat-circle-dots text-kBlue"></i></h2>
    
                <div class="space-y-4">
                    <!-- Q1 -->
                    <div class="bg-white dark:bg-nightSurface rounded-2xl border border-kBorder dark:border-nightBorder overflow-hidden shadow-sm">
                        <button class="faq-btn w-full flex items-center justify-between p-6 text-left focus:outline-none group" aria-expanded="false">
                            <span class="font-bold text-lg dark:text-white">Vad r√§knas som en generering?</span>
                            <div class="w-8 h-8 rounded-full bg-kBg dark:bg-nightBg flex items-center justify-center text-kBlue transition-all duration-300 group-hover:bg-kBlue/10">
                                <i class="ph-bold ph-plus faq-icon"></i>
                            </div>
                        </button>
                        <div class="accordion-content bg-white dark:bg-nightSurface px-6">
                            <div class="pb-6 text-kTextMedium dark:text-gray-400 leading-relaxed">
                                Varje g√•ng du klickar p√• "Generera PRD" eller "Regenerera" r√§knas det som en generering. Att spara, redigera och byta namn p√• PRDs kostar inga credits.
                            </div>
                        </div>
                    </div>
    
                    <!-- Q2 -->
                    <div class="bg-white dark:bg-nightSurface rounded-2xl border border-kBorder dark:border-nightBorder overflow-hidden shadow-sm">
                        <button class="faq-btn w-full flex items-center justify-between p-6 text-left focus:outline-none group" aria-expanded="false">
                            <span class="font-bold text-lg dark:text-white">Vad h√§nder efter min provperiod?</span>
                            <div class="w-8 h-8 rounded-full bg-kBg dark:bg-nightBg flex items-center justify-center text-kBlue transition-all duration-300 group-hover:bg-kBlue/10">
                                <i class="ph-bold ph-plus faq-icon"></i>
                            </div>
                        </button>
                        <div class="accordion-content bg-white dark:bg-nightSurface px-6">
                            <div class="pb-6 text-kTextMedium dark:text-gray-400 leading-relaxed">
                                N√§r din provperiod √§r slut beh√∂ver du v√§lja en plan f√∂r att forts√§tta generera PRDs. Om du inte v√§ljer en plan beh√•ller du l√§s√•tkomst till dina befintliga PRDs.
                            </div>
                        </div>
                    </div>
    
                    <!-- Q3 -->
                    <div class="bg-white dark:bg-nightSurface rounded-2xl border border-kBorder dark:border-nightBorder overflow-hidden shadow-sm">
                        <button class="faq-btn w-full flex items-center justify-between p-6 text-left focus:outline-none group" aria-expanded="false">
                            <span class="font-bold text-lg dark:text-white">Kan jag byta plan?</span>
                            <div class="w-8 h-8 rounded-full bg-kBg dark:bg-nightBg flex items-center justify-center text-kBlue transition-all duration-300 group-hover:bg-kBlue/10">
                                <i class="ph-bold ph-plus faq-icon"></i>
                            </div>
                        </button>
                        <div class="accordion-content bg-white dark:bg-nightSurface px-6">
                            <div class="pb-6 text-kTextMedium dark:text-gray-400 leading-relaxed">
                                Jajamen! Du kan uppgradera eller nedgradera din plan n√§r som helst via din faktureringspanel.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- 9. Final CTA -->
        <section class="py-24 text-center px-6 relative overflow-hidden">
             <!-- ... (Content preserved) ... -->
             <div class="absolute inset-0 bg-gradient-to-b from-transparent to-kBlue/5 pointer-events-none"></div>
             <div class="max-w-2xl mx-auto relative z-10">
                 <h2 class="text-4xl md:text-5xl font-extrabold mb-8 flex items-center justify-center gap-3">Redo att bygga n√•got riktigt? <i class="ph-fill ph-rocket-launch text-kPurple"></i></h2>
                 <a href="#generate" class="inline-flex items-center gap-2 bg-gradient-to-r from-kBlue to-kPurple text-white text-xl font-bold py-5 px-12 rounded-full shadow-button hover:shadow-glow hover:-translate-y-1 hover:scale-105 transition-all duration-300">
                     Generera din egen PRD <i class="ph-fill ph-sparkle"></i>
                 </a>
             </div>
        </section>

        <!-- 10. Footer -->
        <footer class="bg-kBg dark:bg-nightSurface pt-16 pb-8 border-t border-kBorder dark:border-nightBorder">
             <div class="max-w-6xl mx-auto px-6">
                <div class="grid md:grid-cols-4 gap-12 mb-12">
                    <div class="md:col-span-2">
                        <div class="flex items-center gap-2 font-bold text-xl mb-4 group">
                            <div class="w-12 h-12 rounded-full bg-gradient-to-br from-kBlue to-kPurple p-[2px]">
                                <img src="https://firebasestorage.googleapis.com/v0/b/nordsym-funnel.firebasestorage.app/o/genPRDfox.svg?alt=media&token=d22b3524-f29c-4313-bebb-2863f8c30b91" class="w-full h-full rounded-full bg-white dark:bg-nightBg p-0.5 object-contain">
                            </div>
                            <span>Gen<span class="text-kBlue">PRD</span></span>
                        </div>
                        <p class="text-kTextMedium dark:text-gray-400 text-sm max-w-xs">
                            Byggt f√∂r byggare som anv√§nder AI f√∂r att bygga 
                            <span class="inline-flex items-baseline transform translate-y-0.5">
                                <i class="ph-fill ph-heart text-kPurple ml-1"></i>
                            </span>
                        </p>
                    </div>
                    
                    <div>
                        <h4 class="font-bold mb-4">Produkt</h4>
                        <ul class="space-y-2 text-sm text-kTextMedium dark:text-gray-400">
                            <li><a href="#" class="hover:text-kBlue transition-colors">Hem</a></li>
                            <li><a href="#pricing" class="hover:text-kBlue transition-colors">Priss√§ttning</a></li>
                            <li><a href="#generate" class="hover:text-kBlue transition-colors">Generera</a></li>
                        </ul>
                    </div>
    
                    <div>
                        <h4 class="font-bold mb-4">Kontakt</h4>
                        <ul class="space-y-3 text-sm text-kTextMedium dark:text-gray-400">
                            <li>
                                <a href="mailto:GenPRD@nordsym.com" class="hover:text-kBlue transition-colors font-medium">
                                    GenPRD@nordsym.com
                                </a>
                            </li>
                            <li class="flex items-center gap-3">
                                <a href="https://x.com/NordSym" target="_blank" class="w-10 h-10 rounded-full bg-kBg dark:bg-nightBg border border-kBorder dark:border-nightBorder flex items-center justify-center hover:bg-black hover:text-white hover:border-black transition-all shadow-sm" aria-label="X (Twitter)">
                                    <i class="ph-fill ph-x-logo text-xl"></i>
                                </a>
                                <a href="https://www.linkedin.com/company/107921985" target="_blank" class="w-10 h-10 rounded-full bg-kBg dark:bg-nightBg border border-kBorder dark:border-nightBorder flex items-center justify-center hover:bg-[#0077b5] hover:text-white hover:border-[#0077b5] transition-all shadow-sm" aria-label="LinkedIn">
                                    <i class="ph-fill ph-linkedin-logo text-xl"></i>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
    
                <div class="border-t border-kBorder dark:border-nightBorder pt-8 flex flex-col md:flex-row justify-between items-center gap-4 text-xs text-kTextMedium dark:text-gray-500">
                    <p>&copy; 2026 GenPRD ‚Ä¢ Byggt av NordSym AB</p>
                    <div class="flex gap-6">
                        <button onclick="toggleInfoModal('privacy', true)" class="hover:text-kTextDark dark:hover:text-white transition-colors">Privacy Policy</button>
                        <button onclick="toggleInfoModal('terms', true)" class="hover:text-kTextDark dark:hover:text-white transition-colors">Terms of Service</button>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- ======================== APP VIEW (ADDED) ======================== -->
    <div id="app-view" class="fixed inset-0 bg-kBg dark:bg-nightBg hidden opacity-0 transition-opacity duration-500 z-50 overflow-hidden flex flex-col">
        
        <!-- App Header -->
        <header class="w-full bg-white/80 dark:bg-nightSurface/80 backdrop-blur-md border-b border-kBorder dark:border-nightBorder z-50 h-16 flex-shrink-0 flex items-center justify-between px-4 md:px-6">
            <div class="flex items-center gap-4">
                <button onclick="window.exitApp()" class="w-10 h-10 rounded-full bg-kBg dark:bg-nightBg hover:bg-kBorder transition-colors flex items-center justify-center text-kTextDark dark:text-white shadow-sm border border-kBorder dark:border-nightBorder" title="Tillbaka till start">
                    <i class="ph-bold ph-arrow-left text-xl"></i>
                </button>
                <div class="flex items-center gap-2">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-kBlue to-kPurple p-[1.5px]">
                        <img src="https://firebasestorage.googleapis.com/v0/b/nordsym-funnel.firebasestorage.app/o/genPRDfox.svg?alt=media&token=d22b3524-f29c-4313-bebb-2863f8c30b91" class="w-full h-full rounded-full bg-white dark:bg-nightSurface p-0.5 object-contain">
                    </div>
                    <span class="font-bold text-lg dark:text-white hidden md:inline">Gen<span class="text-kBlue">PRD</span></span>
                </div>
            </div>
            
            <div class="flex items-center gap-3 md:gap-4">
                <!-- NY UPGRADE CTA -->
                <button id="upgrade-btn" onclick="togglePaymentModal(true)" class="hidden text-xs font-bold text-white bg-gradient-to-r from-kBlue to-kPurple px-4 py-2 rounded-full shadow-button hover:shadow-glow hover:-translate-y-0.5 transition-all">
                    Uppgradera üöÄ
                </button>

                <span id="credits-display" class="hidden md:inline-block text-xs font-bold text-kMint bg-kMint/10 px-3 py-1 rounded-full border border-kMint/20">
                    Laddar credits...
                </span>
                
                <button id="app-theme-toggle" class="w-9 h-9 rounded-full bg-kBg dark:bg-nightBg hover:bg-kBorder transition-colors flex items-center justify-center text-kTextMedium dark:text-white border border-kBorder dark:border-nightBorder">
                    <i class="ph-fill ph-moon text-lg"></i>
                </button>
                
                <div class="hidden md:flex items-center gap-2 bg-kBg dark:bg-nightBg px-3 py-1.5 rounded-full border border-kBorder dark:border-nightBorder">
                    <i class="ph-fill ph-user text-kBlue"></i>
                    <span id="user-email-display" class="text-xs font-bold text-kTextDark dark:text-white max-w-[100px] truncate">Guest</span>
                </div>
                
                <button onclick="window.handleLogout()" class="p-2 text-kTextMedium hover:text-red-500 transition-colors" title="Logga ut">
                    <i class="ph-bold ph-sign-out text-xl"></i>
                </button>
            </div>
        </header>

        <!-- App Container -->
        <div class="flex flex-1 overflow-hidden relative">
            
            <!-- Sidebar: History (Desktop) -->
            <aside class="hidden md:flex w-72 bg-white/50 dark:bg-nightSurface/50 border-r border-kBorder dark:border-nightBorder flex-col backdrop-blur-sm">
                <div class="p-4 border-b border-kBorder dark:border-nightBorder bg-white/50 dark:bg-nightSurface/80">
                    <button onclick="window.newChat()" class="w-full py-3 bg-gradient-to-r from-kBlue to-kPurple text-white font-bold rounded-xl shadow-button hover:shadow-glow hover:-translate-y-0.5 transition-all flex items-center justify-center gap-2">
                        <i class="ph-bold ph-plus"></i> Ny PRD
                    </button>
                </div>
                
                <div class="p-3">
                    <div class="relative">
                        <i class="ph-bold ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-kTextMedium/50"></i>
                        <input type="text" id="history-search" placeholder="S√∂k historik..." class="w-full pl-9 pr-3 py-2 bg-white dark:bg-nightBg border border-kBorder dark:border-nightBorder rounded-lg text-xs font-medium focus:outline-none focus:ring-2 focus:ring-kBlue/50 transition-all dark:text-white placeholder-kTextMedium/50">
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto p-3 space-y-1 custom-scrollbar" id="history-content">
                    <p class="text-center text-kTextMedium/50 text-xs italic mt-4">Inga sparade PRDs √§n</p>
                </div>
            </aside>

            <!-- Main: Chat -->
            <main class="flex-1 flex flex-col bg-transparent relative z-10 w-full">
                <!-- Chat Messages -->
                <div class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 scroll-smooth custom-scrollbar" id="chat-container">
                    <!-- Welcome Message -->
                    <div class="flex gap-4 max-w-3xl mx-auto mt-8">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-kBlue to-kPurple p-[2px] flex-shrink-0 self-start">
                            <img src="https://firebasestorage.googleapis.com/v0/b/nordsym-funnel.firebasestorage.app/o/genPRDfox.svg?alt=media&token=d22b3524-f29c-4313-bebb-2863f8c30b91" class="w-full h-full rounded-full bg-white dark:bg-nightSurface p-0.5 object-contain">
                        </div>
                        <div class="bg-white dark:bg-nightSurface p-6 rounded-2xl rounded-tl-none shadow-soft border border-kBorder dark:border-nightBorder max-w-2xl">
                            <h3 class="font-bold text-lg mb-2 text-kTextDark dark:text-white">Hej! Jag √§r GenPRD. üëã</h3>
                            <p class="text-kTextMedium dark:text-gray-300 leading-relaxed">
                                Ber√§tta vad du vill bygga s√• skapar jag en detaljerad, teknisk specifikation (PRD) redo f√∂r implementering. Jag kan ocks√• hj√§lpa dig att iterera p√• din id√©.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="p-4 md:p-6 bg-gradient-to-t from-kBg via-kBg to-transparent dark:from-nightBg dark:via-nightBg">
                    <div class="max-w-3xl mx-auto relative">
                        <div class="absolute -inset-0.5 bg-gradient-to-r from-kBlue to-kPurple rounded-2xl blur opacity-20 transition duration-500"></div>
                        <div class="relative bg-white dark:bg-nightSurface rounded-2xl shadow-lg border border-kBorder dark:border-nightBorder flex items-end p-2 transition-shadow focus-within:shadow-glow">
                            <textarea 
                                id="app-input" 
                                rows="1" 
                                class="w-full max-h-40 p-3 bg-transparent border-0 focus:ring-0 resize-none text-kTextDark dark:text-white placeholder-kTextMedium/50 text-base md:text-lg leading-relaxed" 
                                placeholder="Beskriv din app..."
                                oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"
                            ></textarea>
                            <button onclick="window.sendMessage()" class="p-3 bg-gradient-to-br from-kBlue to-kPurple text-white rounded-xl shadow-button hover:shadow-glow hover:-translate-y-0.5 transition-all mb-0.5 mr-0.5 flex-shrink-0">
                                <i class="ph-bold ph-paper-plane-right text-lg"></i>
                            </button>
                        </div>
                        <p class="text-center text-[10px] text-kTextMedium/40 mt-2 font-medium uppercase tracking-wider">GenPRD Pro v1.0.2</p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- JS Logic -->
    <script>
        const SUPABASE_URL = 'https://hqkoeyclixjyyewqmjam.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_7owY_2HUh201ZAdgPK1ohw_4Q9xyd8x';

        // --- STRIPE INIT ---
        const stripe = Stripe('pk_live_51Rez3XRtJYK3aJTqlI0XurAMwKr2KdiYjNCG9DGvMgDKKuCodflefm74P7CtK4brbTbFQTSbmoWbA57B5quMPIK500e88MdzEQ');

        document.addEventListener('DOMContentLoaded', () => {
            
            // --- GLOBAL UI ELEMENTS (Moved Up for Safety) ---
            const landingView = document.getElementById('landing-view');
            const appView = document.getElementById('app-view');
            const appInput = document.getElementById('app-input');
            const chatContainer = document.getElementById('chat-container');

            // --- UI HELPERS FOR MODALS ---
            window.toggleAuthModal = function(show) {
                const modal = document.getElementById('auth-modal');
                const content = document.getElementById('auth-modal-content');
                if (!modal || !content) return; // Safety check

                if (show) { 
                    modal.classList.remove('hidden'); 
                    requestAnimationFrame(() => { 
                        modal.classList.remove('opacity-0'); 
                        content.classList.remove('scale-95'); 
                        content.classList.add('scale-100'); 
                    }); 
                } else { 
                    modal.classList.add('opacity-0'); 
                    content.classList.remove('scale-100'); 
                    content.classList.add('scale-95'); 
                    setTimeout(() => { modal.classList.add('hidden'); }, 300); 
                }
            };

            window.togglePaymentModal = function(show) {
                const modal = document.getElementById('payment-modal');
                if (!modal) return; // Safety check
                
                const modalContent = modal.children[0]; 
                if (!modalContent) return; 

                // √ÑNDRAT: Anpassa inneh√•llet om anv√§ndaren redan √§r PRO
                const isPro = userCredits.status === 'pro';
                
                if (show && isPro) {
                    // Om PRO, visa "Hantera Prenumeration" ist√§llet f√∂r k√∂p-knappar
                    // (Enkel hantering genom att byta inneh√•ll dynamiskt eller redirecta direkt)
                    window.manageSubscription(); 
                    return; // √ñppna inte den vanliga modalen
                }

                if (show) { 
                    modal.classList.remove('hidden'); 
                    requestAnimationFrame(() => { 
                        modal.classList.remove('opacity-0'); 
                        modalContent.classList.remove('scale-95'); 
                        modalContent.classList.add('scale-100'); 
                    }); 
                } else { 
                    modal.classList.add('opacity-0'); 
                    modalContent.classList.remove('scale-100'); 
                    modalContent.classList.add('scale-95'); 
                    setTimeout(() => { modal.classList.add('hidden'); }, 300); 
                }
            };

            // --- INFO MODALS LOGIC (NEW) ---
            window.toggleInfoModal = function(type, show) {
                const modalId = type === 'privacy' ? 'privacy-modal' : 'terms-modal';
                const modal = document.getElementById(modalId);
                if (!modal) return;
                
                const content = modal.children[0];
                
                if (show) {
                    modal.classList.remove('hidden');
                    // St√§ng auth modal tillf√§lligt om den √§r √∂ppen f√∂r att undvika √∂verlappning
                    const authModal = document.getElementById('auth-modal');
                    if (authModal && !authModal.classList.contains('hidden')) {
                        authModal.dataset.wasOpen = 'true';
                        toggleAuthModal(false);
                    }

                    requestAnimationFrame(() => {
                        modal.classList.remove('opacity-0');
                        content.classList.remove('scale-95');
                        content.classList.add('scale-100');
                    });
                } else {
                    modal.classList.add('opacity-0');
                    content.classList.remove('scale-100');
                    content.classList.add('scale-95');
                    
                    setTimeout(() => { 
                        modal.classList.add('hidden'); 
                        // √ñppna auth modal igen om den var √∂ppen (f√∂r signup flow)
                        const authModal = document.getElementById('auth-modal');
                        if (authModal && authModal.dataset.wasOpen === 'true') {
                            authModal.dataset.wasOpen = 'false';
                            toggleAuthModal(true);
                        }
                    }, 300);
                }
            };

            // --- STRIPE UPGRADE LOGIC ---
            window.handleUpgrade = async function(priceId) {
                // Ensure logged in
                if (!currentUser) {
                    togglePaymentModal(false);
                    toggleAuthModal(true);
                    return;
                }

                const { error } = await stripe.redirectToCheckout({
                    lineItems: [{ price: priceId, quantity: 1 }],
                    mode: 'subscription',
                    successUrl: 'https://nordsym.github.io/genPRD/?success=true',
                    cancelUrl: 'https://nordsym.github.io/genPRD/?canceled=true',
                    customerEmail: currentUser.email
                });

                if (error) {
                    console.error('Stripe error:', error);
                    alert('N√•got gick fel vid omdirigering till betalning.');
                }
            };

            // √ÑNDRAT: Hantera prenumeration via Stripe Portal Link
            window.manageSubscription = function() {
                // INSTRUKTION:
                // 1. G√• till Stripe Dashboard -> Settings -> Billing -> Customer Portal
                // 2. Klicka "Aktivera l√§nk" under "Lansera kundportalen med en l√§nk"
                // 3. Kopiera l√§nken som ser ut som: https://billing.stripe.com/p/login/....
                // 4. Klistra in den nedanf√∂r:
                
                const portalLink = "https://billing.stripe.com/p/login/cNi3cxdwEdOW1qs95ecMM00"; 

                if (portalLink === "KLISTRA_IN_DIN_STRIPE_L√ÑNK_H√ÑR") {
                    alert("Dev: Du m√•ste klistra in din Stripe Portal-l√§nk i koden (rad ~2380) f√∂r att detta ska fungera.");
                } else {
                    // Eftersom vi anv√§nder "no-code" l√§nken m√•ste anv√§ndaren fylla i sin e-post hos Stripe f√∂r att f√• access
                    // Vi skickar med deras email som 'prefilled_email' f√∂r att g√∂ra det lite smidigare
                    const emailParam = currentUser ? `?prefilled_email=${encodeURIComponent(currentUser.email)}` : '';
                    window.open(portalLink + emailParam, '_blank');
                }
            };

            // Check for success URL param
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('success') === 'true') {
                alert("Betalning genomf√∂rd! üöÄ\n\nDina credits uppdateras inom kort. V√§lkommen till PRO!");
                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }

            // --- PRICING LOGIC ---
            const monthlyBtn = document.getElementById('monthly-btn');
            const yearlyBtn = document.getElementById('yearly-btn');
            const priceAmount = document.getElementById('price-amount');
            const pricePeriod = document.getElementById('price-period');
            const priceSavings = document.getElementById('price-savings');

            if (monthlyBtn && yearlyBtn && priceAmount && pricePeriod && priceSavings) {
                monthlyBtn.addEventListener('click', () => {
                    monthlyBtn.classList.add('bg-kBlue', 'text-white', 'shadow-sm');
                    monthlyBtn.classList.remove('text-kTextMedium', 'hover:text-kBlue');
                    
                    yearlyBtn.classList.remove('bg-kBlue', 'text-white', 'shadow-sm');
                    yearlyBtn.classList.add('text-kTextMedium', 'hover:text-kBlue');
                    
                    // Update Price
                    priceAmount.textContent = '99 kr';
                    pricePeriod.textContent = '/m√•nad';
                    priceSavings.innerHTML = ''; // Clear savings
                });

                yearlyBtn.addEventListener('click', () => {
                    yearlyBtn.classList.add('bg-kBlue', 'text-white', 'shadow-sm');
                    yearlyBtn.classList.remove('text-kTextMedium', 'hover:text-kBlue');
                    
                    monthlyBtn.classList.remove('bg-kBlue', 'text-white', 'shadow-sm');
                    monthlyBtn.classList.add('text-kTextMedium', 'hover:text-kBlue');
                    
                    // Update Price
                    priceAmount.textContent = '891 kr';
                    pricePeriod.textContent = '/√•r';
                    // √ÑNDRAT: Ikon ist√§llet f√∂r emoji, kortare text
                    priceSavings.innerHTML = '<span class="inline-flex items-center gap-1 bg-kMint/20 text-kMint px-2 py-0.5 rounded-full text-xs font-bold"><i class="ph-fill ph-tag"></i> -25%</span>';
                });
            }

            // --- CAROUSEL LOGIC (NEW) ---
            let currentSlide = 1;
            window.switchCarousel = function(action) {
                const s1 = document.getElementById('carousel-slide-1');
                const s2 = document.getElementById('carousel-slide-2');
                const d1 = document.getElementById('dot-1');
                const d2 = document.getElementById('dot-2');

                if (!s1 || !s2) return;

                // Determine target slide
                let target = 1;
                if (typeof action === 'number') {
                    target = action;
                } else if (action === 'next' || action === 'prev') {
                    target = currentSlide === 1 ? 2 : 1;
                }

                if (target === 1) {
                    s1.classList.remove('-translate-x-full');
                    s2.classList.add('translate-x-full');
                    
                    d1.classList.remove('bg-gray-300', 'dark:bg-gray-600');
                    d1.classList.add('bg-kBlue');
                    d2.classList.add('bg-gray-300', 'dark:bg-gray-600');
                    d2.classList.remove('bg-kBlue');
                    currentSlide = 1;
                } else {
                    s1.classList.add('-translate-x-full');
                    s2.classList.remove('translate-x-full');
                    
                    d2.classList.remove('bg-gray-300', 'dark:bg-gray-600');
                    d2.classList.add('bg-kBlue');
                    d1.classList.add('bg-gray-300', 'dark:bg-gray-600');
                    d1.classList.remove('bg-kBlue');
                    currentSlide = 2;
                }
            };

            // --- SUPABASE INIT ---
            let supabase;
            let currentUser = null;
            let userPRDs = [];
            let userCredits = { used: 0, limit: 50, status: 'free' };

            try {
                if (window.supabase) {
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    console.log("Supabase Initialized");
                    
                    // Auto-login logic
                    const hash = window.location.hash;
                    if (hash && (hash.includes('access_token') || hash.includes('type=signup'))) {
                        supabase.auth.getSession().then(({ data: { session } }) => {
                            if (session) {
                                checkSession(); 
                                window.location.hash = ''; 
                                window.enterApp(); 
                            }
                        });
                    } else {
                        checkSession();
                    }

                    fetchLiveStats(); 

                    // NEW: Handle Password Reset Flow
                    const resetParams = new URLSearchParams(window.location.search);
                    if (resetParams.get('reset') === 'true') {
                        setTimeout(async () => {
                            const newPassword = prompt('üîê V√§lj nytt l√∂senord:\n\n(Minst 6 tecken)');
                            
                            if (newPassword && newPassword.length >= 6) {
                                try {
                                    const { error } = await supabase.auth.updateUser({ password: newPassword });
                                    if (error) throw error;
                                    
                                    alert('‚úÖ L√∂senord uppdaterat!\n\nDu kan nu logga in med ditt nya l√∂senord.');
                                    window.history.replaceState({}, document.title, window.location.pathname);
                                } catch (e) {
                                    console.error('Password update error:', e);
                                    alert('‚ùå Kunde inte uppdatera l√∂senord: ' + e.message);
                                }
                            } else if (newPassword !== null) {
                                alert('‚ö†Ô∏è L√∂senordet m√•ste vara minst 6 tecken.');
                            }
                        }, 500);
                    }

                } else {
                    console.error("Supabase SDK not loaded");
                }
            } catch (e) {
                console.error("Supabase Init Error:", e);
            }

            // --- STATS FUNCTION ---
            async function fetchLiveStats() {
                try {
                    const { data, error } = await supabase.rpc('get_landing_stats');
                    if (error) throw error;

                    if (data) {
                        const buildersEl = document.getElementById('stats-builders');
                        if (buildersEl) {
                            const displayCount = data.builders || 0; 
                            buildersEl.innerHTML = `${displayCount} <span class="text-sm font-normal text-kTextMedium">byggare</span>`;
                        }

                        const prdsEl = document.getElementById('stats-generated');
                        if (prdsEl) {
                            const displayCount = data.prds || 0;
                            prdsEl.innerHTML = `${displayCount} <span class="text-sm font-normal text-kTextMedium">genererade</span>`;
                        }
                    }
                } catch (err) {
                    // Silent fail for stats is fine
                }
            }

            // --- AUTH FUNCTIONS ---

            async function checkSession() {
                const { data: { session } } = await supabase.auth.getSession();
                currentUser = session?.user || null;
                updateAuthUI();
                
                if (currentUser) {
                    await fetchUserCredits();
                }

                supabase.auth.onAuthStateChange((_event, session) => {
                    currentUser = session?.user || null;
                    updateAuthUI();
                });
            }
            
            async function fetchUserCredits() {
                if (!currentUser) return;
                try {
                    let { data, error } = await supabase
                        .from('user_credits')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .single();

                    // FIX: Om anv√§ndaren saknar rad i user_credits (skapad f√∂re trigger), skapa den nu!
                    if (error && error.code === 'PGRST116') {
                        console.log("Inga credits hittades, initierar ny anv√§ndare...");
                        const startDate = new Date();
                        const expiryDate = new Date();
                        expiryDate.setDate(startDate.getDate() + 7);

                        const { data: newData, error: insertError } = await supabase
                            .from('user_credits')
                            .insert([{
                                user_id: currentUser.id,
                                credits_used: 0,
                                credits_limit: 50,
                                subscription_status: 'trial',
                                trial_started_at: startDate.toISOString(),
                                trial_expires_at: expiryDate.toISOString()
                            }])
                            .select()
                            .single();
                        
                        if (newData) {
                            data = newData;
                            error = null;
                        }
                    }

                    if (data) {
                        const now = new Date();
                        let status = data.subscription_status;
                        let expiresAt = data.trial_expires_at ? new Date(data.trial_expires_at) : null;

                        // Check Expiry logic (samma som f√∂rut)
                        if (status === 'trial' && expiresAt && now > expiresAt) {
                            // ... existing expiry logic (visuell uppdatering i UI sk√∂ts av updateCreditsDisplay)
                            status = 'expired';
                        }

                        userCredits = {
                            used: data.credits_used,
                            limit: data.credits_limit,
                            status: status,
                            trial_expires_at: expiresAt
                        };
                    }
                    // Flyttad till finally-blocket nedan f√∂r s√§kerhet
                } catch (e) {
                    console.error('Error fetching credits', e);
                } finally {
                    // GARANTERA att UI uppdateras oavsett databas-status
                    updateCreditsDisplay();
                }
            }

            function updateCreditsDisplay() {
                const display = document.getElementById('credits-display');
                const upgradeBtn = document.getElementById('upgrade-btn'); // H√§mta knappen

                if (display && currentUser) {
                    // Reset classes
                    display.className = 'hidden md:inline-block text-xs font-bold px-3 py-1 rounded-full border';
                    display.onclick = null; // Clear previous handlers

                    // Hantera Upgrade Button Visibility
                    if (upgradeBtn) {
                        if (userCredits.status === 'pro') {
                            upgradeBtn.classList.add('hidden');
                        } else {
                            upgradeBtn.classList.remove('hidden');
                            // Om trial g√•tt ut, g√∂r knappen r√∂d/uppm√§rksamhetss√∂kande (optional)
                            if (userCredits.status === 'expired') {
                                upgradeBtn.classList.remove('from-kBlue', 'to-kPurple');
                                upgradeBtn.classList.add('from-red-500', 'to-red-600', 'animate-pulse');
                            }
                        }
                    }

                    if (userCredits.status === 'pro') {
                        display.textContent = '‚àû genereringar (PRO)';
                        display.classList.add('text-kPurple', 'bg-kPurple/10', 'border-kPurple/20');
                    } else if (userCredits.status === 'expired') {
                        display.textContent = 'Trial slut ‚Äì Uppgradera';
                        display.classList.add('text-red-500', 'bg-red-100', 'border-red-200', 'cursor-pointer', 'hover:bg-red-200');
                        display.onclick = () => togglePaymentModal(true);
                    } else {
                        // Active Trial
                        const remaining = userCredits.limit - userCredits.used;
                        let daysLeft = 0;
                        if (userCredits.trial_expires_at) {
                            const diffTime = userCredits.trial_expires_at - new Date();
                            daysLeft = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                            if (daysLeft < 0) daysLeft = 0;
                        }
                        
                        display.textContent = `${remaining} kvar ‚Ä¢ ${daysLeft}d trial`;
                        
                        if (remaining <= 0) {
                            display.classList.add('text-red-500', 'bg-red-100', 'border-red-200', 'cursor-pointer');
                            display.onclick = () => togglePaymentModal(true);
                        } else {
                            display.classList.add('text-kMint', 'bg-kMint/10', 'border-kMint/20');
                        }
                    }
                }
            }

            function updateAuthUI() {
                const navContainer = document.getElementById('nav-auth-container');
                const userEmailDisplay = document.getElementById('user-email-display');

                if (currentUser) {
                    if (navContainer) {
                        navContainer.innerHTML = `
                            <button onclick="window.enterApp()" class="px-5 py-2 rounded-full bg-kBlue/10 text-kBlue font-bold hover:bg-kBlue hover:text-white transition-all shadow-sm border border-kBlue/20">
                                G√• till Appen <i class="ph-bold ph-arrow-right"></i>
                            </button>
                        `;
                    }
                    if (userEmailDisplay) {
                        userEmailDisplay.textContent = currentUser.email;
                    }
                } else {
                    if (navContainer) {
                        navContainer.innerHTML = `
                             <button onclick="toggleAuthModal(true)" class="hidden md:inline-block font-semibold text-kBlue hover:text-kPurple transition-colors">Sign in</button>
                        `;
                    }
                }
            }

            // FIXED: Improved error handling and debugging
            window.handleLogin = async (e) => {
                e.preventDefault();
                // FIX: Trim whitespace from email
                const email = document.getElementById('login-email').value.trim(); 
                const password = document.getElementById('login-password').value;
                const btn = document.getElementById('login-btn');
                const errorContainer = document.getElementById('login-error-container');
                const errorText = document.getElementById('login-error-text');
                
                // Clear previous errors
                if (errorContainer) errorContainer.classList.add('hidden');
                
                // Debug logging
                console.log("=== LOGIN DEBUG ===");
                console.log("Email:", email);
                console.log("Password length:", password ? password.length : 0);
                
                btn.innerHTML = '<i class="ph-bold ph-spinner animate-spin text-xl"></i>';
                btn.disabled = true;

                try {
                    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                    
                    if (error) {
                        console.error("Login error object:", error);
                        throw error;
                    }
                    
                    console.log("Login successful:", data);
                    toggleAuthModal(false);
                    window.enterApp(); 
                } catch (error) {
                    console.error("Catch block error:", error);
                    
                    let msg = "";
                    
                    // Specific error mapping for Swedish context
                    if (error.message.includes('Email not confirmed')) {
                        msg = '‚ö†Ô∏è Email ej bekr√§ftad.<br><br>Du m√•ste klicka p√• l√§nken i mailet vi skickade innan du kan logga in.<br><br><button onclick="window.resendConfirmation()" class="underline font-bold hover:text-red-800">Skicka nytt mail</button>';
                    } else if (error.message.includes('Invalid login credentials')) {
                        msg = '‚ùå Fel email eller l√∂senord.<br><br><b>Tips:</b> Har du bekr√§ftat din email? Om du nyss skapade kontot m√•ste du klicka p√• l√§nken i mailet f√∂rst.';
                    } else {
                        msg = 'Inloggning misslyckades: ' + error.message;
                    }

                    if (errorContainer && errorText) {
                        errorText.innerHTML = msg;
                        errorContainer.classList.remove('hidden');
                    } else {
                        alert(msg.replace(/<br>/g, '\n').replace(/<b>/g, '').replace(/<\/b>/g, ''));
                    }

                } finally {
                    if(btn) {
                        btn.innerHTML = 'Logga in';
                        btn.disabled = false;
                    }
                }
            };

            // NEW: Resend Confirmation Logic
            window.resendConfirmation = async function() {
                const email = document.getElementById('login-email').value;
                if (!email) {
                    alert('‚ö†Ô∏è V√§nligen fyll i din email-adress i f√§ltet ovanf√∂r f√∂rst.');
                    return;
                }
                
                const btn = event.target; 
                const originalText = btn.innerText;
                btn.innerText = "Skickar...";
                btn.disabled = true;

                try {
                    const { error } = await supabase.auth.resend({
                        type: 'signup',
                        email: email,
                        options: {
                            emailRedirectTo: 'https://nordsym.github.io/genPRD/'
                        }
                    });
                    
                    if (error) throw error;
                    
                    alert(`‚úÖ Nytt bekr√§ftelsemail skickat till ${email}.\n\nKolla din inkorg (och skr√§ppost) och klicka p√• l√§nken!`);
                } catch (e) {
                    console.error("Resend error:", e);
                    if (e.message.includes('Too many requests') || e.status === 429) {
                        alert('‚è≥ V√§nta lite innan du skickar igen (anti-spam skydd).');
                    } else {
                        alert('Kunde inte skicka email: ' + e.message);
                    }
                } finally {
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            };

            // NEW: Password Reset Request
            window.handlePasswordReset = async function() {
                const email = document.getElementById('login-email').value;
                
                if (!email || !email.includes('@')) {
                    alert('‚ö†Ô∏è Ange din email i f√§ltet ovan f√∂rst');
                    document.getElementById('login-email').focus();
                    return;
                }
                
                try {
                    const { error } = await supabase.auth.resetPasswordForEmail(email, {
                        redirectTo: 'https://nordsym.github.io/genPRD/?reset=true'
                    });
                    
                    if (error) throw error;
                    
                    alert(`‚úÖ √Öterst√§llningsl√§nk skickad!\n\nüìß Kolla ${email}\n\nKlicka p√• l√§nken i mailet f√∂r att v√§lja nytt l√∂senord.\n\nüîç Kolla √§ven skr√§ppost.`);
                } catch (e) {
                    console.error('Password reset error:', e);
                    alert('‚ùå Kunde inte skicka √•terst√§llningsl√§nk.\n\nKontrollera att emailen √§r korrekt.');
                }
            };

            // FIXED: Explicit confirmation instructions
            window.handleSignup = async (e) => {
                e.preventDefault();
                const email = document.getElementById('signup-email').value;
                const password = document.getElementById('signup-password').value;
                const btn = document.getElementById('signup-btn');

                btn.innerHTML = '<i class="ph-bold ph-spinner animate-spin text-xl"></i>';
                btn.disabled = true;

                try {
                    const { data, error } = await supabase.auth.signUp({ 
                        email, 
                        password,
                        options: {
                            emailRedirectTo: 'https://nordsym.github.io/genPRD/'
                        }
                    });
                    
                    if (error) throw error;
                    
                    alert(`‚úÖ Konto skapat!\n\nüìß Bekr√§ftelsel√§nk skickad till:\n${email}\n\n‚ö†Ô∏è VIKTIGT:\nDu M√ÖSTE klicka p√• l√§nken i mailet innan du kan logga in n√§sta g√•ng.\n\nKolla √§ven skr√§ppost om du inte ser mailet.`);
                    toggleAuthModal(false);
                } catch (error) {
                    alert('Kunde inte skapa konto: ' + error.message);
                } finally {
                    if(btn) {
                        btn.innerHTML = 'Skapa konto';
                        btn.disabled = false;
                    }
                }
            };

            window.handleLogout = async () => {
                await supabase.auth.signOut();
                window.exitApp();
            };

            // --- DATABASE FUNCTIONS ---

            async function fetchHistory() {
                const historyContent = document.getElementById('history-content');
                if(!historyContent) return; // Safety

                historyContent.innerHTML = '<p class="px-2 py-2 text-xs text-center text-kTextMedium/50 italic">Laddar...</p>';

                if (!currentUser) {
                    renderMockHistory();
                    return;
                }

                try {
                    const { data, error } = await supabase
                        .from('prds')
                        .select('id, title, created_at')
                        .order('created_at', { ascending: false });

                    if (error) throw error;

                    userPRDs = data || [];
                    renderHistoryList(userPRDs);

                } catch (err) {
                    console.error("Error fetching history:", err);
                    historyContent.innerHTML = '<p class="px-2 py-2 text-xs text-center text-red-400 italic">Kunde inte ladda historik.</p>';
                }
            }

            // √ÑNDRAT: Ny funktion f√∂r att byta namn p√• PRD
            window.renamePrd = async (e, id, currentTitle) => {
                e.stopPropagation(); // F√∂rhindra att PRDn laddas n√§r man klickar p√• pennan
                const newTitle = prompt("Ange nytt namn f√∂r din PRD:", currentTitle);
                
                if (newTitle && newTitle.trim() !== "" && newTitle !== currentTitle) {
                    try {
                        const { error } = await supabase
                            .from('prds')
                            .update({ title: newTitle.trim() })
                            .eq('id', id);

                        if (error) throw error;
                        
                        // Uppdatera listan lokalt f√∂r snabbhet
                        const prdIndex = userPRDs.findIndex(p => p.id === id);
                        if (prdIndex > -1) userPRDs[prdIndex].title = newTitle.trim();
                        renderHistoryList(userPRDs);
                        
                    } catch (err) {
                        console.error("Error renaming:", err);
                        alert("Kunde inte byta namn. F√∂rs√∂k igen.");
                    }
                }
            };

            function renderHistoryList(prds) {
                const historyContent = document.getElementById('history-content');
                if(!historyContent) return;

                if (prds.length === 0) {
                    historyContent.innerHTML = '<p class="px-2 py-2 text-xs text-center text-kTextMedium/50 italic">Inga PRDs √§n. Skapa din f√∂rsta!</p>';
                    return;
                }

                let html = '';
                prds.forEach(prd => {
                    // √ÑNDRAT: Lade till rename-knapp
                    html += `
                        <div class="group relative flex items-center w-full p-2 rounded-xl hover:bg-white dark:hover:bg-nightBorder/50 transition-colors">
                            <button onclick="loadPrdFromDb('${prd.id}')" class="flex-grow text-left overflow-hidden mr-2">
                                <div class="font-bold text-sm text-kTextDark dark:text-gray-200 truncate">${prd.title || 'Namnl√∂s PRD'}</div>
                                <div class="text-xs text-kTextMedium dark:text-gray-500 mt-0.5">${new Date(prd.created_at).toLocaleDateString()}</div>
                            </button>
                            <button onclick="renamePrd(event, '${prd.id}', '${prd.title || ''}')" class="p-1.5 text-kTextMedium hover:text-kBlue opacity-0 group-hover:opacity-100 transition-opacity" title="Byt namn">
                                <i class="ph-bold ph-pencil-simple"></i>
                            </button>
                        </div>
                    `;
                });
                historyContent.innerHTML = html;
            }
            
            // --- HISTORY SEARCH ---
            const historySearchInput = document.getElementById('history-search');
            if (historySearchInput) {
                historySearchInput.addEventListener('input', (e) => {
                    const query = e.target.value.toLowerCase().trim();
                    if (!query) {
                        renderHistoryList(userPRDs);
                        return;
                    }
                    const filtered = userPRDs.filter(prd => 
                        (prd.title || '').toLowerCase().includes(query)
                    );
                    renderHistoryList(filtered);
                });
            }

            async function saveToDb(title, prompt, content) {
                if (!currentUser) return; 

                try {
                    const { error } = await supabase.from('prds').insert({
                        user_id: currentUser.id,
                        title: title,
                        prompt: prompt,
                        content: content,
                        created_at: new Date().toISOString()
                    });

                    if (error) throw error;
                    
                    // Refresh history
                    const { data } = await supabase
                        .from('prds')
                        .select('id, title, created_at')
                        .order('created_at', { ascending: false });
                    if (data) {
                        userPRDs = data; 
                        renderHistoryList(data);
                    }

                } catch (err) {
                    console.error("Failed to save PRD:", err);
                }
            }

            // √ÑNDRAT: Ny funktion f√∂r Regenerate
            window.regeneratePrd = function(promptText) {
                // Decode om det beh√∂vs, men h√§r skickar vi r√•str√§ngen
                if(appInput) {
                    appInput.value = promptText; // S√§tt input till ursprungliga prompten
                    window.sendMessage(); // K√∂r
                }
            };

            window.loadPrdFromDb = async (id) => {
                const chatContainer = document.getElementById('chat-container');
                if(!chatContainer) return;

                chatContainer.innerHTML = '<div class="flex items-center justify-center h-full"><i class="ph-bold ph-spinner animate-spin text-3xl text-kBlue"></i></div>';
                
                // Highlight active (simple logical highlight, UI highlight handled by hover mostly in new structure)
                
                try {
                    const { data, error } = await supabase
                        .from('prds')
                        .select('*')
                        .eq('id', id)
                        .single();

                    if (error) throw error;
                    
                    // Reconstruct Chat
                    chatContainer.innerHTML = '';
                    
                    // 1. User Message (Prompt)
                    const userMsg = document.createElement('div');
                    userMsg.className = 'flex gap-4 max-w-3xl mx-auto flex-row-reverse';
                    userMsg.innerHTML = `
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-kPink to-kPurple p-[2px] flex-shrink-0">
                            <div class="w-full h-full rounded-full bg-white dark:bg-nightSurface flex items-center justify-center text-kPurple">
                                <i class="ph-fill ph-user text-2xl"></i>
                            </div>
                        </div>
                        <div class="bg-kBlue text-white p-5 rounded-2xl rounded-tr-none shadow-soft">
                            <p class="leading-relaxed">${data.prompt.replace(/\n/g, '<br>')}</p>
                        </div>
                    `;
                    chatContainer.appendChild(userMsg);

                    // 2. AI Message (Content)
                    const encodedContent = encodeURIComponent(data.content);
                    // √ÑNDRAT: Escape prompt f√∂r att kunna anv√§ndas i JS-anrop
                    const escapedPrompt = data.prompt.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    const htmlContent = marked.parse(data.content); 

                    const aiMsg = document.createElement('div');
                    aiMsg.className = 'flex gap-4 max-w-3xl mx-auto';
                    aiMsg.innerHTML = `
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-kBlue to-kPurple p-[2px] flex-shrink-0">
                            <img src="https://firebasestorage.googleapis.com/v0/b/nordsym-funnel.firebasestorage.app/o/foxPRDinhand.svg?alt=media&token=3665cc00-1523-4614-9a21-fece3f034020" class="w-full h-full rounded-full bg-white dark:bg-nightSurface p-1 object-contain">
                        </div>
                        <div class="bg-white dark:bg-nightSurface p-6 rounded-2xl rounded-tl-none shadow-soft border border-kBorder dark:border-nightBorder w-full overflow-hidden">
                            <div class="flex justify-between items-center mb-4 border-b border-kBorder dark:border-nightBorder pb-3">
                                <div>
                                    <p class="text-kTextDark dark:text-gray-200 font-bold text-lg">Sparad PRD üìÇ</p>
                                </div>
                                <div class="flex gap-2">
                                    <!-- √ÑNDRAT: Regenerera-knapp tillagd -->
                                    <button onclick="window.regeneratePrd('${escapedPrompt}')" class="p-2 bg-kBg dark:bg-nightBg hover:bg-kBorder rounded-lg text-kTextMedium transition-colors" title="Regenerera">
                                        <i class="ph-bold ph-arrows-clockwise"></i>
                                    </button>
                                    <button onclick="window.print()" class="p-2 bg-kBg dark:bg-nightBg hover:bg-kBorder rounded-lg text-kTextMedium transition-colors" title="Spara som PDF">
                                        <i class="ph-bold ph-file-pdf"></i>
                                    </button>
                                    <button onclick="window.copyToClipboard('${encodedContent}', this)" class="p-2 bg-kBg dark:bg-nightBg hover:bg-kBorder rounded-lg text-kTextMedium transition-colors" title="Kopiera Markdown">
                                        <i class="ph-bold ph-copy"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="prose dark:prose-invert max-w-none text-sm text-kTextDark dark:text-gray-300 prd-content font-sans leading-relaxed">
                                ${htmlContent}
                            </div>
                        </div>
                    `;
                    chatContainer.appendChild(aiMsg);

                } catch (err) {
                    chatContainer.innerHTML = '<p class="text-center text-red-500 mt-10">Kunde inte ladda PRD.</p>';
                }
            };

            // --- UI HELPERS ---

            window.switchAuthMode = function(mode) {
                const loginView = document.getElementById('login-view');
                const signupView = document.getElementById('signup-view');
                if(!loginView || !signupView) return; // Safety

                if (mode === 'signup') {
                    loginView.classList.add('hidden');
                    signupView.classList.remove('hidden');
                } else {
                    signupView.classList.add('hidden');
                    loginView.classList.remove('hidden');
                }
            };

            // --- Spec Expander Logic ---
            window.toggleSpec = function() {
                const el = document.getElementById('spec-content');
                if(!el) return;

                if (el.classList.contains('hidden')) {
                    el.classList.remove('hidden');
                    void el.offsetWidth;
                    el.classList.remove('max-h-0', 'opacity-0');
                    el.classList.add('max-h-[5000px]', 'opacity-100'); 
                    setTimeout(() => { el.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 100);
                } else {
                    el.classList.add('max-h-0', 'opacity-0');
                    el.classList.remove('max-h-[5000px]', 'opacity-100');
                    setTimeout(() => { el.classList.add('hidden'); }, 700);
                }
            };

            // --- Showcase Segmented Control ---
            window.switchShowcase = function(state) {
                const indicator = document.getElementById('segment-indicator');
                const btnWithout = document.querySelector('.segment-btn:nth-child(2)'); 
                const btnWith = document.querySelector('.segment-btn:nth-child(3)');
                const visualWithout = document.getElementById('visual-without');
                const visualWith = document.getElementById('visual-with');
                const contentWithout = document.getElementById('content-without');
                const contentWith = document.getElementById('content-with');
                
                // SAFETY CHECKS
                if(!indicator || !btnWithout || !btnWith || !visualWithout || !visualWith || !contentWithout || !contentWith) return;

                if (state === 'without') {
                    indicator.style.left = '4px';
                    indicator.classList.remove('state-good');
                    indicator.classList.add('state-bad');
                    btnWithout.classList.add('active-bad');
                    btnWithout.classList.remove('active-good');
                    btnWith.classList.remove('active-good', 'active-bad');
                    
                    visualWithout.style.opacity = '1'; visualWithout.style.zIndex = '10'; visualWithout.style.pointerEvents = 'auto';
                    visualWith.style.opacity = '0'; visualWith.style.zIndex = '0'; visualWith.style.pointerEvents = 'none';
                    
                    contentWithout.style.opacity = '1'; contentWithout.style.transform = 'translateX(0)'; contentWithout.style.zIndex = '10'; contentWithout.style.pointerEvents = 'auto';
                    contentWith.style.opacity = '0'; contentWith.style.transform = 'translateX(8px)'; contentWith.style.zIndex = '0'; contentWith.style.pointerEvents = 'none';
                    
                } else if (state === 'with') {
                    indicator.style.left = '148px';
                    indicator.classList.remove('state-bad');
                    indicator.classList.add('state-good');
                    btnWith.classList.add('active-good');
                    btnWith.classList.remove('active-bad');
                    btnWithout.classList.remove('active-good', 'active-bad');
                    
                    visualWith.style.opacity = '1'; visualWith.style.zIndex = '10'; visualWith.style.pointerEvents = 'auto';
                    visualWithout.style.opacity = '0'; visualWithout.style.zIndex = '0'; visualWithout.style.pointerEvents = 'none';
                    
                    contentWith.style.opacity = '1'; contentWith.style.transform = 'translateX(0)'; contentWith.style.zIndex = '10'; contentWith.style.pointerEvents = 'auto';
                    contentWithout.style.opacity = '0'; contentWithout.style.transform = 'translateX(-8px)'; contentWithout.style.zIndex = '0'; contentWithout.style.pointerEvents = 'none';
                }
            };

            // --- Typewriter Effect ---
            const inputField = document.getElementById('prd-input');
            const placeholderTexts = [
                "Bygg en landningssida f√∂r en ny SaaS-produkt med priss√§ttning...",
                "En app f√∂r att sp√•ra vanor och gamifiera livet med v√§nner...",
                "Ett internt verktyg f√∂r lagerhantering och orderl√§ggning...",
                "En marknadsplats f√∂r begagnade kursb√∂cker med chattfunktion..."
            ];
            
            let textIndex = 0;
            let charIndex = 0;
            let isDeleting = false;
            let typeSpeed = 50;
            let typewriterTimeout;
            let typewriterActive = true;
            
            function typeWriter() {
                if (!inputField || !typewriterActive) return;
                const currentText = placeholderTexts[textIndex];
                if (isDeleting) {
                    inputField.setAttribute('placeholder', currentText.substring(0, charIndex - 1));
                    charIndex--; typeSpeed = 30;
                } else {
                    inputField.setAttribute('placeholder', currentText.substring(0, charIndex + 1));
                    charIndex++; typeSpeed = 50 + Math.random() * 50;
                }
                if (!isDeleting && charIndex === currentText.length) { isDeleting = true; typeSpeed = 2000; } 
                else if (isDeleting && charIndex === 0) { isDeleting = false; textIndex = (textIndex + 1) % placeholderTexts.length; typeSpeed = 500; }
                typewriterTimeout = setTimeout(typeWriter, typeSpeed);
            }
            typeWriter();

            if (inputField) {
                inputField.addEventListener('focus', () => {
                    typewriterActive = false;
                    clearTimeout(typewriterTimeout);
                    inputField.placeholder = "Beskriv vad du vill bygga...";
                });
            }

            // --- APP LOGIC ---
            
            // --- MOCK DATA (Fallback) ---
            const mockChatHistory = {
                'chat-1': [
                    { type: 'ai', text: 'Hej! Jag √§r GenPRD. üëã \n\nBer√§tta vad du vill bygga s√• skapar jag en detaljerad, teknisk specifikation (PRD) redo f√∂r implementering.' },
                    { type: 'user', text: 'Jag beh√∂ver en landningssida f√∂r min nya SaaS-tj√§nst.' },
                    { type: 'ai', text: 'Uppfattat! H√§r √§r ett utkast...' }
                ]
            };
            
            function renderMockHistory() {
                const historyContent = document.getElementById('history-content');
                if(historyContent) {
                    historyContent.innerHTML = `
                        <p class="px-2 py-2 text-xs text-center text-kTextMedium/50 italic mb-2">Dev Mode (Offline)</p>
                        <button onclick="loadChat('chat-1')" class="w-full text-left p-3 rounded-xl hover:bg-white dark:hover:bg-nightBorder/50 transition-colors group relative history-item" id="btn-chat-1">
                             <div class="font-bold text-sm text-kTextDark dark:text-gray-200 truncate pr-4">SaaS Landningssida</div>
                             <div class="text-xs text-kTextMedium dark:text-gray-500 mt-0.5">Mock Data</div>
                        </button>
                    `;
                }
            }

            // Old loadChat for Mock Data compatibility
            window.loadChat = function(chatId) {
                if(!chatContainer) return;
                const history = mockChatHistory[chatId];
                if (!history) return;
                chatContainer.innerHTML = '';
                history.forEach(msg => {
                   const div = document.createElement('div');
                   div.className = msg.type === 'user' ? 'flex gap-4 max-w-3xl mx-auto flex-row-reverse' : 'flex gap-4 max-w-3xl mx-auto';
                   div.innerHTML = `<div class="p-4 bg-gray-100 rounded-lg">${msg.text}</div>`; 
                   chatContainer.appendChild(div);
                });
            };

            // --- DOWNLOAD & COPY LOGIC (Preserved) ---
            window.downloadMarkdown = function(encodedContent, filename) {
                try {
                    const text = decodeURIComponent(encodedContent);
                    const blob = new Blob([text], { type: 'text/markdown' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a'); a.href = url; a.download = (filename || 'GenPRD-Spec') + '.md';
                    document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
                } catch (e) { alert("Kunde inte ladda ner filen."); }
            };

            window.copyToClipboard = function(encodedContent, btnElement) {
                const text = decodeURIComponent(encodedContent);
                const originalHTML = btnElement.innerHTML;
                const showSuccess = () => {
                    btnElement.innerHTML = '<i class="ph-bold ph-check"></i> Kopierat!';
                    btnElement.classList.add('bg-kMint/20', 'text-kMint');
                    setTimeout(() => { btnElement.innerHTML = originalHTML; btnElement.classList.remove('bg-kMint/20', 'text-kMint'); }, 2000);
                };
                const textArea = document.createElement("textarea"); textArea.value = text;
                textArea.style.position = "fixed"; textArea.style.left = "-9999px";
                document.body.appendChild(textArea); textArea.focus(); textArea.select();
                try { if (document.execCommand('copy')) showSuccess(); } catch (err) {}
                document.body.removeChild(textArea);
            };

            window.enterApp = function() {
                // F√∂rb√§ttrad uppslagning av element
                let landing = document.getElementById('landing-view');
                let app = document.getElementById('app-view');
                
                // Fallback om getElementById misslyckas (ovanligt men m√∂jligt i vissa milj√∂er)
                if (!landing) landing = document.querySelector('#landing-view');
                if (!app) app = document.querySelector('#app-view');
                
                if(!landing || !app) {
                    console.error("Critical Error: Navigation views not found.", { landing, app });
                    alert("Ett tekniskt fel uppstod: Kan inte hitta app-vyn. Prova att ladda om sidan.");
                    return; 
                }

                console.log("Navigating to App..."); // Debug log

                // Nollst√§ll scroll och transitions
                window.scrollTo(0, 0);
                
                landing.style.opacity = '0';
                
                // Anv√§nd setTimeout f√∂r att s√§kerst√§lla att transition hinner starta
                setTimeout(() => {
                    landing.classList.add('hidden');
                    app.classList.remove('hidden');
                    
                    // Force reflow
                    void app.offsetWidth;
                    
                    requestAnimationFrame(() => { 
                        app.style.opacity = '1'; 
                    });
                    
                    document.body.style.overflow = 'hidden';
                    fetchHistory();
                }, 500);
            };

            window.enterAppWithPrompt = function() {
                const input = document.getElementById('prd-input');
                if (!input) return;
                const prompt = input.value;
                
                window.enterApp();
                
                if (prompt.trim()) {
                    setTimeout(() => {
                        const aiInput = document.getElementById('app-input');
                        if(aiInput) {
                            aiInput.value = prompt;
                            // Anpassa h√∂jden
                            aiInput.style.height = 'auto';
                            aiInput.style.height = aiInput.scrollHeight + 'px';
                            window.sendMessage();
                        }
                    }, 800);
                }
            };

            window.exitApp = function() {
                const landing = document.getElementById('landing-view');
                const app = document.getElementById('app-view');
                
                if(!landing || !app) return;

                app.style.opacity = '0';
                setTimeout(() => {
                    app.classList.add('hidden');
                    landing.classList.remove('hidden');
                    
                    // Force reflow
                    void landing.offsetWidth;

                    requestAnimationFrame(() => { landing.style.opacity = '1'; });
                    document.body.style.overflow = '';
                }, 500);
            };

            window.newChat = function() {
                if(!chatContainer) return;
                chatContainer.innerHTML = `
                <div class="flex gap-4 max-w-3xl mx-auto">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-kBlue to-kPurple p-[2px] flex-shrink-0">
                        <img src="https://firebasestorage.googleapis.com/v0/b/nordsym-funnel.firebasestorage.app/o/genPRDfox.svg?alt=media&token=f98a5d70-29ea-4303-b002-3bc4fade6599" class="w-full h-full rounded-full bg-white dark:bg-nightSurface p-1 object-contain">
                    </div>
                    <div class="bg-white dark:bg-nightSurface p-5 rounded-2xl rounded-tl-none shadow-soft border border-kBorder dark:border-nightBorder">
                        <p class="text-kTextDark dark:text-gray-200 leading-relaxed">
                            Ny session startad. Vad bygger vi h√§rn√§st? ‚ú®
                        </p>
                    </div>
                </div>`;
                if(appInput) appInput.placeholder = "Beskriv din app...";
            };

            window.sendMessage = async function() {
                if(!appInput || !chatContainer) return;
                const text = appInput.value.trim();
                if (!text) return;
                
                // CHECK CREDITS & TRIAL STATUS
                if (currentUser) {
                    const isPro = userCredits.status === 'pro';
                    const isTrial = userCredits.status === 'trial';
                    const isExpired = userCredits.status === 'expired';
                    
                    // 1. Block if expired
                    if (!isPro && isExpired) {
                        togglePaymentModal(true);
                        // Add system message
                        const sysMsg = document.createElement('div');
                        sysMsg.className = 'flex justify-center my-4';
                        sysMsg.innerHTML = `<span class="bg-red-100 text-red-600 px-4 py-2 rounded-full text-xs font-bold shadow-sm">Din trial har g√•tt ut üéØ. Uppgradera f√∂r att forts√§tta bygga.</span>`;
                        chatContainer.appendChild(sysMsg);
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                        return;
                    }

                    // 2. Block if trial active but no credits
                    if (!isPro && isTrial && userCredits.used >= userCredits.limit) {
                        togglePaymentModal(true);
                        const sysMsg = document.createElement('div');
                        sysMsg.className = 'flex justify-center my-4';
                        sysMsg.innerHTML = `<span class="bg-orange-100 text-orange-600 px-4 py-2 rounded-full text-xs font-bold shadow-sm">Slut p√• trial-credits. Uppgradera f√∂r obegr√§nsad tillg√•ng.</span>`;
                        chatContainer.appendChild(sysMsg);
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                        return;
                    }
                }

                const userMsg = document.createElement('div');
                userMsg.className = 'flex gap-4 max-w-3xl mx-auto flex-row-reverse';
                userMsg.innerHTML = `
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-kPink to-kPurple p-[2px] flex-shrink-0">
                        <div class="w-full h-full rounded-full bg-white dark:bg-nightSurface flex items-center justify-center text-kPurple">
                            <i class="ph-fill ph-user text-2xl"></i>
                        </div>
                    </div>
                    <div class="bg-kBlue text-white p-5 rounded-2xl rounded-tr-none shadow-soft">
                        <p class="leading-relaxed">${text.replace(/\n/g, '<br>')}</p>
                    </div>
                `;
                chatContainer.appendChild(userMsg);
                appInput.value = ''; appInput.style.height = 'auto'; chatContainer.scrollTop = chatContainer.scrollHeight;

                const loadingId = 'loading-' + Date.now();
                const aiLoading = document.createElement('div'); aiLoading.id = loadingId;
                aiLoading.className = 'flex gap-4 max-w-3xl mx-auto';
                aiLoading.innerHTML = `
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-kBlue to-kPurple p-[2px] flex-shrink-0">
                        <img src="https://firebasestorage.googleapis.com/v0/b/nordsym-funnel.firebasestorage.app/o/foxPRDthink.svg?alt=media&token=f22ea0fe-8edd-41de-84e0-b87e706ea07d" class="w-full h-full rounded-full bg-white dark:bg-nightSurface p-1 object-contain">
                    </div>
                    <div class="bg-white dark:bg-nightSurface p-5 rounded-2xl rounded-tl-none shadow-soft border border-kBorder dark:border-nightBorder flex items-center gap-2">
                        <div class="w-2 h-2 bg-kBlue rounded-full animate-bounce"></div> <div class="w-2 h-2 bg-kPurple rounded-full animate-bounce delay-100"></div> <div class="w-2 h-2 bg-kPink rounded-full animate-bounce delay-200"></div>
                    </div>`;
                chatContainer.appendChild(aiLoading); chatContainer.scrollTop = chatContainer.scrollHeight;

                setTimeout(async () => {
                    const loadingEl = document.getElementById(loadingId); if (loadingEl) loadingEl.remove();

                    const productName = (text.split(' ')[0].length > 2 ? text.split(' ')[0] : 'App') + 'Spec';
                    const prdMarkdown = `# Product Requirements Document (PRD): ${productName}\n\n## 1. Executive Summary\n**Product:** ${productName}\n**Goal:** ${text}\n\n## 2. Core Features\n- **User Auth:** Secure login/signup via Supabase.\n- **Main Flow:** Optimized for high conversion.\n- **Admin Panel:** Data visualization and user management.\n\n## 3. Tech Stack\n- Frontend: React + Tailwind CSS\n- Backend: Supabase (PostgreSQL)\n- Deployment: Vercel\n\n*Generated by GenPRD*`;
                    
                    const htmlContent = marked.parse(prdMarkdown);

                    await saveToDb(productName, text, prdMarkdown);

                    if (currentUser) {
                        const isPro = userCredits.status === 'pro';
                        if (!isPro) {
                            userCredits.used += 1;
                            await supabase
                                .from('user_credits')
                                .upsert({ 
                                    user_id: currentUser.id, 
                                    credits_used: userCredits.used 
                                });
                            updateCreditsDisplay();
                        }
                    }

                    if(appInput) appInput.placeholder = "Vill du f√∂rfina n√•got? T.ex. 'L√§gg till OAuth login'";

                    const encodedContent = encodeURIComponent(prdMarkdown);
                    // √ÑNDRAT: Escape prompt h√§r ocks√• f√∂r regenerate-knappen i den nya chat-bubblan
                    const escapedPrompt = text.replace(/'/g, "\\'").replace(/"/g, '&quot;');

                    const aiMsg = document.createElement('div');
                    aiMsg.className = 'flex gap-4 max-w-3xl mx-auto';
                    aiMsg.innerHTML = `
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-kBlue to-kPurple p-[2px] flex-shrink-0">
                            <img src="https://firebasestorage.googleapis.com/v0/b/nordsym-funnel.firebasestorage.app/o/foxPRDinhand.svg?alt=media&token=3665cc00-1523-4614-9a21-fece3f034020" class="w-full h-full rounded-full bg-white dark:bg-nightSurface p-1 object-contain">
                        </div>
                        <div class="bg-white dark:bg-nightSurface p-6 rounded-2xl rounded-tl-none shadow-soft border border-kBorder dark:border-nightBorder w-full overflow-hidden">
                            <div class="flex justify-between items-center mb-4 border-b border-kBorder dark:border-nightBorder pb-3">
                                <div>
                                    <p class="text-kTextDark dark:text-gray-200 font-bold text-lg">PRD Genererad! üöÄ</p>
                                </div>
                                <div class="flex gap-2">
                                    <!-- √ÑNDRAT: Regenerera-knapp tillagd -->
                                    <button onclick="window.regeneratePrd('${escapedPrompt}')" class="p-2 bg-kBg dark:bg-nightBg hover:bg-kBorder rounded-lg text-kTextMedium transition-colors" title="Regenerera">
                                        <i class="ph-bold ph-arrows-clockwise"></i>
                                    </button>
                                    <button onclick="window.print()" class="p-2 bg-kBg dark:bg-nightBg hover:bg-kBorder rounded-lg text-kTextMedium transition-colors" title="Spara som PDF">
                                        <i class="ph-bold ph-file-pdf"></i>
                                    </button>
                                    <button onclick="window.copyToClipboard('${encodedContent}', this)" class="p-2 bg-kBg dark:bg-nightBg hover:bg-kBorder rounded-lg text-kTextMedium transition-colors" title="Kopiera Markdown">
                                        <i class="ph-bold ph-copy"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="prose dark:prose-invert max-w-none text-sm text-kTextDark dark:text-gray-300 prd-content font-sans leading-relaxed">
                                ${htmlContent}
                            </div>
                        </div>
                    `;
                    chatContainer.appendChild(aiMsg); chatContainer.scrollTop = chatContainer.scrollHeight;
                }, 2000);
            };

            if (appInput) {
                appInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); window.sendMessage(); }});
            }

            // --- Theme Logic ---
            const themeToggleBtn = document.getElementById('theme-toggle');
            const themeIcon = document.getElementById('theme-icon');
            const appThemeToggle = document.getElementById('app-theme-toggle');
            const html = document.documentElement;
            const themeKey = 'genprd-theme-v1'; 
            
            function setTheme(isDark) {
                const appIcon = appThemeToggle ? appThemeToggle.querySelector('i') : null;
                if (isDark) {
                    html.classList.add('dark'); localStorage.setItem(themeKey, 'dark');
                    if(themeIcon) { themeIcon.classList.remove('ph-moon'); themeIcon.classList.add('ph-sun'); }
                    if (appIcon) { appIcon.classList.remove('ph-moon'); appIcon.classList.add('ph-sun'); }
                } else {
                    html.classList.remove('dark'); localStorage.setItem(themeKey, 'light');
                    if(themeIcon) { themeIcon.classList.remove('ph-sun'); themeIcon.classList.add('ph-moon'); }
                    if (appIcon) { appIcon.classList.remove('ph-sun'); appIcon.classList.add('ph-moon'); }
                }
            }
            
            if (localStorage.getItem(themeKey) === 'dark') setTheme(true); else setTheme(false);
            
            if (themeToggleBtn) themeToggleBtn.addEventListener('click', () => setTheme(!html.classList.contains('dark')));
            if (appThemeToggle) appThemeToggle.addEventListener('click', () => setTheme(!html.classList.contains('dark')));

            // --- FAQ Accordion Logic ---
            document.querySelectorAll('.faq-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const content = btn.nextElementSibling;
                    const iconContainer = btn.querySelector('div');
                    const icon = btn.querySelector('.faq-icon');
                    
                    // Toggle active class on content
                    content.classList.toggle('active');
                    
                    // Toggle icon style
                    if (content.classList.contains('active')) {
                        icon.classList.remove('ph-plus');
                        icon.classList.add('ph-minus');
                        iconContainer.classList.add('bg-kBlue', 'text-white', 'rotate-180');
                        iconContainer.classList.remove('bg-kBg', 'dark:bg-nightBg', 'text-kBlue', 'group-hover:bg-kBlue/10');
                    } else {
                        icon.classList.add('ph-plus');
                        icon.classList.remove('ph-minus');
                        iconContainer.classList.remove('bg-kBlue', 'text-white', 'rotate-180');
                        iconContainer.classList.add('bg-kBg', 'dark:bg-nightBg', 'text-kBlue', 'group-hover:bg-kBlue/10');
                    }
                });
            });

            // --- Mobile Menu ---
            const menuBtn = document.getElementById('mobile-menu-btn');
            const closeMenuBtn = document.getElementById('close-menu-btn');
            const menu = document.getElementById('mobile-menu');
            const menuLinks = menu ? menu.querySelectorAll('a') : [];
            function toggleMenu(show) {
                if (!menu) return;
                if (show) { menu.classList.remove('translate-x-full'); document.body.style.overflow = 'hidden'; } 
                else { menu.classList.add('translate-x-full'); document.body.style.overflow = ''; }
            }
            if (menuBtn) menuBtn.addEventListener('click', () => toggleMenu(true));
            if (closeMenuBtn) closeMenuBtn.addEventListener('click', () => toggleMenu(false));
            if (menuLinks.length > 0) menuLinks.forEach(link => link.addEventListener('click', () => toggleMenu(false)));

        });
    </script>
</body>
</html>
